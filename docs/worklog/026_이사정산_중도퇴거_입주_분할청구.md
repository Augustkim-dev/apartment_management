# 026. 이사 정산 - 중도 퇴거/입주 분할 청구 기능

**날짜**: 2026-02-11
**관련 계획**: `docs/plans/009_이사정산_중도퇴거_입주_분할청구.md`

## 개요

월 중간에 퇴거/입주가 발생하면 같은 호실에 퇴거자·입주자 각각 별도 청구서를 발행하는 기능 추가.
퇴거 시점에 건물 전체 요금이 미확정이므로 직전 3개월 평균 데이터로 추정 정산하고, 차액은 건물 관리비로 흡수.

## 변경 사항

### 신규 파일 (12개)

| 파일 | 설명 |
|------|------|
| `scripts/migration_009_move_settlement.sql` | DB 마이그레이션 (tenants, move_settlements 테이블 생성, unit_bills 변경) |
| `types/move-settlement.ts` | 이사 정산 API 요청/응답 타입 |
| `lib/services/estimation.service.ts` | 3개월 평균 기반 추정 계산 엔진 |
| `lib/services/move-settlement.service.ts` | 이사 정산 비즈니스 로직 (퇴거/입주/목록/상세) |
| `app/api/move-settlements/route.ts` | 이사 정산 목록 조회 (GET) / 생성 (POST) |
| `app/api/move-settlements/[id]/route.ts` | 이사 정산 상세 (GET) / 입주자등록·상태변경 (PATCH) |
| `app/api/move-settlements/estimate/route.ts` | 추정 금액 미리보기 (POST) |
| `app/api/tenants/route.ts` | 입주자 목록 (GET) / 등록 (POST) |
| `app/api/tenants/[id]/route.ts` | 입주자 상세 (GET) / 수정 (PATCH) |
| `app/dashboard/move-settlements/page.tsx` | 이사 정산 목록 페이지 |
| `app/dashboard/move-settlements/new/page.tsx` | 이사 정산 생성 (5단계 멀티스텝 폼) |
| `app/dashboard/move-settlements/[id]/page.tsx` | 이사 정산 상세 페이지 |

### 수정 파일 (5개)

| 파일 | 변경 내용 |
|------|----------|
| `types/database.ts` | `Tenant`, `MoveSettlement` 인터페이스 추가, `UnitBill` 7개 필드 확장 |
| `lib/services/unit-bills.service.ts` | `saveCalculationResults()` - move_out 보호, move_in 생성, tenant JOIN |
| `app/api/bills/[id]/units/route.ts` | 응답에 `billType`, `isEstimated`, `tenantNameSnapshot` 추가 |
| `app/dashboard/bills/[id]/page.tsx` | 호실 테이블에 퇴거/입주/추정 배지 표시 |
| `app/dashboard/layout.tsx` | 사이드바에 "이사 정산" 메뉴 추가 |

### 계획 문서 수정

| 파일 | 변경 내용 |
|------|----------|
| `docs/plans/009_이사정산_중도퇴거_입주_분할청구.md` | 구현 계획서 (신규) |
| `docs/plans/README.md` | Phase 9 항목 추가 |

## 기술 상세

### DB 변경
- **tenants** 테이블: 입주자 이력 관리 (active/moved_out)
- **move_settlements** 테이블: 이사 정산 이벤트 추적
- **unit_bills** 변경: `bill_type` (regular/move_out/move_in), `tenant_id`, `is_estimated` 등 7개 컬럼 추가
- UNIQUE KEY 변경: `(monthly_bill_id, unit_id)` → `(monthly_bill_id, unit_id, bill_type, tenant_id)`

### 추정 계산 로직
```
1. 직전 3개월 monthly_bills 데이터 조회
2. 8개 요금항목 + 전체 사용량 평균 계산
3. usageRatio = 퇴거자사용량 / 평균건물사용량
4. 각 항목 = 평균항목 × usageRatio (10원 단위 반올림)
```

### 재계산 시 보호 로직
- `DELETE FROM unit_bills WHERE bill_type IN ('regular', 'move_in')` → move_out 보호
- 이사 정산 호실: `입주자사용량 = 전체사용량 - 퇴거자사용량` 으로 move_in 재생성

### 이사 정산 생성 흐름 (멀티스텝)
1. 호실 선택 → 현재 입주자 자동 표시
2. 퇴거 일시 + 계량기값 입력
3. 추정 금액 미리보기 (3개월 평균 기반)
4. 입주자 등록 (선택, 나중에 등록 가능)
5. 확인 및 정산 실행

## 검증 방법

- DB 마이그레이션 후 `tenants` 테이블 생성 확인
- 기존 `unit_bills`에 `tenant_id`, `bill_type='regular'` 연결 확인
- 관리자가 개발 서버에서 직접 이사 정산 시나리오 테스트
