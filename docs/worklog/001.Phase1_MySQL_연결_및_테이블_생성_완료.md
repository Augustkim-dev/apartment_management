# Phase 1: MySQL 연결 및 테이블 생성 - 작업 완료

**작업 일시**: 2025-01-15  
**작업자**: Claude  
**상태**: ✅ 완료

## 📋 작업 개요

아르노빌리지 전기료 관리 시스템의 기반이 되는 데이터베이스 구축 및 Next.js 프로젝트 초기 설정을 완료했습니다.

## 🎯 완료된 작업

### 1. Next.js 프로젝트 생성
- **프로젝트명**: coloco-apartment
- **프레임워크**: Next.js 14 (App Router)
- **언어**: TypeScript
- **스타일링**: Tailwind CSS

```bash
npx create-next-app@latest coloco-apartment --typescript --tailwind --app --no-src-dir --import-alias "@/*"
```

### 2. 필요 패키지 설치
```bash
npm install mysql2 dotenv
```

### 3. 프로젝트 구조
```
coloco-apartment/
├── app/
│   ├── api/
│   │   └── test-db/
│   │       └── route.ts        # DB 연결 테스트 API
│   └── page.tsx
├── lib/
│   ├── db.ts                   # MySQL 연결 풀
│   └── db-utils.ts              # DB 유틸리티 함수
├── scripts/
│   └── init-db.sql              # DB 초기화 SQL
├── .env.local.example           # 환경 변수 템플릿
└── README.md                    # 프로젝트 문서
```

### 4. 데이터베이스 스키마

#### 생성된 테이블 (5개)

1. **users** - 사용자 관리
   - id, username, password, role, timestamps

2. **units** - 호실 정보
   - id, unit_number, tenant_name, contact, email, status, dates

3. **monthly_bills** - 월별 총 청구서
   - id, bill_year, bill_month, billing_period, amounts, fees

4. **unit_bills** - 호실별 청구서
   - id, monthly_bill_id, unit_id, usage, amounts, payment_status

5. **bill_history** - 청구서 변경 이력
   - id, unit_bill_id, action, old_values, new_values, timestamps

### 5. 초기 데이터
- 60개 호실 데이터 입력
- 58개 입주, 2개 공실 (404호, 703호)

## 🔧 구현된 주요 기능

### DB 연결 모듈 (`lib/db.ts`)
- MySQL2 연결 풀 구성
- 환경 변수 기반 설정
- 자동 재연결 기능

### DB 유틸리티 (`lib/db-utils.ts`)
- `query()` - SELECT 쿼리 실행
- `execute()` - INSERT/UPDATE/DELETE 실행
- `transaction()` - 트랜잭션 처리
- `queryOne()` - 단일 행 조회
- `exists()` - 존재 여부 확인

### 연결 테스트 API (`/api/test-db`)
- 데이터베이스 연결 확인
- 테이블 목록 조회
- 호실 통계 표시

## 🐛 발생한 이슈 및 해결

### 이슈 1: MySQL JSON 타입 미지원
- **문제**: MySQL 버전이 JSON 타입을 지원하지 않음 (ERROR 1064)
- **해결**: `bill_history` 테이블의 JSON 컬럼을 TEXT로 변경
```sql
-- 변경 전
old_values JSON,
new_values JSON,

-- 변경 후  
old_values TEXT COMMENT 'JSON 형식으로 저장',
new_values TEXT COMMENT 'JSON 형식으로 저장',
```

## ✅ 테스트 결과

### DB 연결 테스트 성공
```json
{
  "success": true,
  "message": "데이터베이스 연결 성공!",
  "database": "coloco_apartment",
  "tables": [
    "bill_history",
    "monthly_bills",
    "units",
    "unit_bills",
    "users"
  ],
  "unitStats": {
    "total": 60,
    "occupied": 58,
    "vacant": 2
  },
  "timestamp": "2025-09-15T04:00:42.962Z"
}
```

## 📝 환경 설정

### .env.local 파일 구성
```env
MYSQL_HOST=원격-서버-IP
MYSQL_PORT=3306
MYSQL_USER=사용자명
MYSQL_PASSWORD=비밀번호
MYSQL_DATABASE=coloco_apartment
MYSQL_CONNECTION_LIMIT=5
MYSQL_QUEUE_LIMIT=0
MYSQL_CONNECT_TIMEOUT=60000
NODE_ENV=development
```

## 🚀 실행 방법

1. 환경 변수 설정
```bash
cp .env.local.example .env.local
# .env.local 파일에 실제 DB 정보 입력
```

2. 데이터베이스 초기화
```bash
mysql -h server-ip -u root -p < scripts/init-db.sql
```

3. 개발 서버 실행
```bash
npm run dev
```

4. 연결 테스트
```
http://localhost:3000/api/test-db
```

## 📊 작업 시간
- 예상 시간: 6시간
- 실제 소요: 약 1시간
- 효율성: 83% 단축

## 🎯 다음 단계

**Phase 2: PDF/Excel 파싱 API 구현**
- 한전 청구서 PDF 자동 파싱
- Excel 사용량 데이터 처리
- 파일 업로드 인터페이스
- 데이터 추출 및 검증

## 📌 참고 사항

1. **보안**: `.env.local` 파일은 절대 Git에 커밋하지 않음
2. **원격 DB**: 방화벽에서 3306 포트 개방 필요
3. **문자셋**: UTF8MB4 사용으로 한글 문제 없음
4. **연결 풀**: 최대 5개 연결로 제한

---

**문서 작성일**: 2025-01-15  
**문서 버전**: 1.0