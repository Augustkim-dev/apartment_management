# 비밀번호 인증 시스템 보안 개선

## 📌 작업 개요
- **작업일**: 2025-09-17
- **작업자**: Claude
- **작업 유형**: 버그 수정 및 보안 개선
- **관련 Phase**: Phase 6 (인증 시스템)

## 🐛 발견된 문제

### 1. 사용자 로그인 실패
- **증상**: 일반 사용자(viewer)가 '0000'으로 로그인 시 "아이디 또는 비밀번호가 올바르지 않습니다" 오류
- **원인**:
  - 데이터베이스의 비밀번호 해시값이 실제 '0000'과 매치되지 않음
  - auth.ts에서 admin 계정만 하드코딩으로 '0000' 바이패스 처리

### 2. 보안 취약점
- admin 계정에 하드코딩된 비밀번호 바이패스 존재
- 일관되지 않은 인증 로직 (admin과 일반 사용자 다른 처리)

## 🔧 해결 과정

### 1. 문제 진단
```javascript
// 기존 해시값 검증
const oldHash = '$2a$10$kJQXxmPCH3MlE1Y8vGGKuOhI6K.0RpNZBqYQlFvHhLHLYH3Y6qH3m';
bcrypt.compare('0000', oldHash) // 결과: false

// 올바른 '0000' 해시 생성
const correctHash = bcrypt.hashSync('0000', 10);
// 결과: $2b$10$DjzpmGZpxPEUBjbisW1KFuW8T8vEEtqd2JL7b0wO2qs15H4HCjmjS
```

### 2. 데이터베이스 수정
```sql
-- 모든 사용자의 비밀번호를 올바른 '0000' 해시로 업데이트
UPDATE users
SET password = '$2b$10$DjzpmGZpxPEUBjbisW1KFuW8T8vEEtqd2JL7b0wO2qs15H4HCjmjS'
WHERE role IN ('admin', 'viewer');
```

### 3. auth.ts 보안 개선

#### 변경 전:
```typescript
// 비밀번호 검증 - 임시로 admin/0000은 통과
if (credentials.username === 'admin' && credentials.password === '0000') {
  // admin 계정 임시 처리
} else {
  const isValid = await bcrypt.compare(credentials.password, user.password);
  if (!isValid) {
    return null;
  }
}
```

#### 변경 후:
```typescript
// 비밀번호 검증
const isValid = await bcrypt.compare(credentials.password, user.password);
if (!isValid) {
  console.log(`Login failed for user: ${credentials.username}`);
  return null;
}
```

## ✅ 개선 결과

### 1. 보안 강화
- 하드코딩된 비밀번호 바이패스 제거
- 모든 계정에 동일한 보안 수준 적용
- bcrypt 해싱을 통한 안전한 비밀번호 저장

### 2. 일관성 개선
- admin과 viewer 모두 동일한 인증 로직 적용
- 코드 단순화 및 유지보수성 향상

### 3. 문제 해결
- 모든 사용자가 '0000'으로 정상 로그인 가능
- admin: username 'admin', password '0000'
- viewer: username 'user_XXX', password '0000'

## 📝 교훈

### 1. 해시 검증의 중요성
- 비밀번호 해시를 생성할 때는 반드시 검증 필요
- bcrypt의 salt rounds와 prefix($2a vs $2b)에 주의

### 2. 보안 우선 원칙
- 개발 편의를 위한 바이패스는 보안 취약점이 될 수 있음
- 모든 사용자에게 동일한 보안 정책 적용 필요

### 3. 일관된 코드 작성
- 특정 계정에 대한 예외 처리 최소화
- 단순하고 명확한 인증 로직 유지

## 🔐 향후 고려사항

1. **프로덕션 배포 전**:
   - 기본 비밀번호 '0000' 변경 강제화
   - 비밀번호 복잡도 정책 적용
   - 비밀번호 변경 기능 구현

2. **추가 보안 기능**:
   - 로그인 시도 횟수 제한
   - 비밀번호 재설정 기능
   - 2단계 인증 (2FA) 도입 검토

## 📊 영향 범위
- 영향받은 사용자: 48명 (admin 1명 + viewer 47명)
- 수정된 파일:
  - `/lib/auth.ts`
  - 데이터베이스 `users` 테이블

## 🎯 완료 상태
✅ 문제 진단 완료
✅ 데이터베이스 비밀번호 해시 업데이트
✅ auth.ts 보안 개선
✅ 로그인 테스트 성공
✅ 워크로그 작성