# 023. 사용자 청구서 페이지 개선

## 작업 일자
2025-12-08

## 작업 내용

### 1. 미납 청구서 표시 버그 수정

#### 문제 현상
- DB에 `payment_status='pending'` 상태의 미납 청구서(id=611, 2025년 7월)가 존재
- 사용자 화면에서 미납 건수: 0건, 미납 총액: 0원으로 표시
- 전체 청구서 목록에서도 해당 미납 청구서가 보이지 않음

#### 원인 분석
사용자의 `moveInDate`가 2025년 8월로 설정되어 있어서, 7월 청구서가 쿼리에서 제외됨

기존 쿼리:
```sql
WHERE ub.unit_id = ?
AND DATE(CONCAT(mb.bill_year, '-', LPAD(mb.bill_month, 2, '0'), '-01')) >= moveInDate
AND DATE(CONCAT(mb.bill_year, '-', LPAD(mb.bill_month, 2, '0'), '-01')) <= moveOutDate
```

- 7월 청구서: `2025-07-01` < `2025-08-01` (moveInDate) → 제외됨
- 8월 이후 청구서: 포함됨

#### 해결 방법
`moveInDate/moveOutDate` 필터를 제거하여 해당 호실(unit_id)의 모든 청구서를 조회하도록 변경

---

### 2. 전체 보기 페이지 기능 개선

#### 추가된 기능
1. **필터링 기능**: 전체/납부완료/미납 탭으로 청구서 필터링
2. **페이징 기능**: 페이지 번호 네비게이션 추가
3. **전체 미납 통계**: 요약 카드에 전체 미납 건수/금액 표시

---

### 3. CVE-2025-55182 보안 취약점 패치

#### 취약점 정보
- **CVE**: CVE-2025-55182
- **심각도**: 높음 (High)
- **유형**: 원격 코드 실행 (RCE)
- **영향**: React 19 및 Next.js의 Server Components

#### 업데이트 내역
| 패키지 | 이전 버전 | 패치 버전 |
|--------|-----------|-----------|
| next | 15.5.3 | 15.5.7 |
| react | 19.1.0 | 19.1.2 |
| react-dom | 19.1.0 | 19.1.2 |
| eslint-config-next | 15.5.3 | 15.5.7 |

---

## 수정 파일

### 미납 청구서 버그 수정
| 파일 | 변경 내용 |
|------|-----------|
| `app/my/page.tsx` | moveInDate 필터 제거, 전체 미납 통계 별도 쿼리 |
| `app/api/my/bills/route.ts` | moveInDate 필터 제거 |

### 전체 보기 페이지 개선
| 파일 | 변경 내용 |
|------|-----------|
| `app/api/my/bills/route.ts` | 신규 생성 - 페이징/필터링 API |
| `app/my/bills/page.tsx` | 클라이언트 컴포넌트로 전환, 필터/페이징 UI |
| `app/api/my/bills/[id]/route.ts` | 미납 내역 LIMIT 12 제거 |

### 보안 패치
| 파일 | 변경 내용 |
|------|-----------|
| `package.json` | next, react, react-dom, eslint-config-next 버전 업데이트 |
| `package-lock.json` | 의존성 갱신 |

---

## 코드 변경 상세

### app/my/page.tsx - 청구서 조회 쿼리 변경

**변경 전:**
```typescript
const moveInDate = session.user.moveInDate || '2024-01-01';
const moveOutDate = session.user.moveOutDate || '2099-12-31';

const recentBills = await query<UnitBill[]>(`
  SELECT ...
  FROM unit_bills ub
  JOIN monthly_bills mb ON ub.monthly_bill_id = mb.id
  JOIN units u ON ub.unit_id = u.id
  WHERE ub.unit_id = ?
  AND DATE(CONCAT(mb.bill_year, '-', LPAD(mb.bill_month, 2, '0'), '-01')) >= ?
  AND DATE(CONCAT(mb.bill_year, '-', LPAD(mb.bill_month, 2, '0'), '-01')) <= ?
  ORDER BY mb.bill_year DESC, mb.bill_month DESC
  LIMIT 6
`, [session.user.unitId, moveInDate, moveOutDate]);
```

**변경 후:**
```typescript
const recentBills = await query<UnitBill[]>(`
  SELECT ...
  FROM unit_bills ub
  JOIN monthly_bills mb ON ub.monthly_bill_id = mb.id
  JOIN units u ON ub.unit_id = u.id
  WHERE ub.unit_id = ?
  ORDER BY mb.bill_year DESC, mb.bill_month DESC
  LIMIT 6
`, [session.user.unitId]);
```

### app/api/my/bills/route.ts - 전체 미납 통계 쿼리

```typescript
const unpaidStatsResult = await query<UnpaidStats[]>(`
  SELECT
    COUNT(*) as unpaid_count,
    COALESCE(SUM(ub.total_amount), 0) as unpaid_total
  FROM unit_bills ub
  WHERE ub.unit_id = ?
  AND ub.payment_status != 'paid'
`, [session.user.unitId]);
```

---

## 테스트 결과

### 미납 청구서 표시 테스트
- **테스트 대상**: unit_id=35 (403호)
- **미납 청구서**: id=611 (2025년 7월, 23,650원)
- **예상 결과**: 납부 대기 1건, 23,650원 표시
- **실제 결과**: 정상 표시됨

### 전체 보기 페이지 테스트
- 필터 탭 정상 동작 (전체/납부완료/미납)
- 페이징 정상 동작
- 요약 통계 정확히 계산됨

---

## Git 커밋

```
901d085 feat: 사용자 청구서 페이지 개선 - 전체 미납 통계 및 페이징/필터링
6b9660e security: CVE-2025-55182 취약점 패치 - Next.js 및 React 업데이트
c9a90ec fix: 미납 청구서가 표시되지 않는 버그 수정
```

---

## 관련 이슈

- 사용자 로그인 시 첫 페이지에서 납부 대기 건수/총액이 최근 6개월만 계산되는 문제
- 전체 보기에서 페이징/필터링 기능 부재
- moveInDate 이전 청구서가 표시되지 않는 버그
- CVE-2025-55182 보안 취약점
