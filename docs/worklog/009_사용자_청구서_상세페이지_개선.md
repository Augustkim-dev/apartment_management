# 009. 사용자 청구서 상세 페이지 개선

## 작업일
2025-09-17

## 작업 내용

### 1. 데이터베이스 컬럼 매핑 오류 수정
- **문제점**: unit_bills 테이블의 실제 컬럼명과 코드의 컬럼명 불일치
- **해결방법**:
  - `basic_charge` → `basic_fee`
  - `usage_charge` → `power_fee`
  - `climate_charge` → `climate_fee`
  - `fuel_charge` → `fuel_fee`
  - `usage_count` → `usage_amount`
  - Next.js 15에서 params를 await 처리

### 2. 사용자 청구서 상세 페이지 전면 개편
- **관리자 페이지와 동일한 수준의 상세 정보 제공**
- **클라이언트 컴포넌트로 변경**: 탭 전환 등 인터랙션 지원
- **4개 탭 구성**:
  1. 납부 정보 (기본 탭)
  2. 요금 상세
  3. 검침 정보
  4. 건물 전체

### 3. API 엔드포인트 생성
- **경로**: `/api/my/bills/[id]/route.ts`
- **기능**:
  - 사용자 인증 및 권한 확인 (본인 호실만 조회 가능)
  - 전월 청구 정보 비교
  - 미납 내역 조회
  - 건물 전체 정보 제공
  - 납부 안내사항 포함

### 4. 모바일 반응형 디자인 적용
- **모바일 (sm)**:
  - 단일 컬럼 레이아웃
  - 세로 스크롤 최적화
  - 탭 메뉴 가로 스크롤 지원
  - 전월 비교 정보 별도 카드로 표시
- **태블릿 (md)**: 2컬럼 그리드
- **데스크톱 (lg)**: 4컬럼 그리드
- **테이블**: 모바일에서 가로 스크롤 가능
- **텍스트 크기**: 디바이스별 적응형 (text-xs → text-sm → text-base)

### 5. UI/UX 개선 사항
- **호실 정보 카드**: 그라디언트 배경의 요약 정보
- **요약 통계 카드**:
  - 전월 대비 증감 (색상 코드: 증가-빨강, 감소-초록)
  - 당월 사용량 및 비율
  - 미납금액 알림 (빨간색 강조)
  - 납기일 D-Day 표시
- **계좌 복사 버튼**: 클립보드 복사 기능
- **인쇄 버튼**: 브라우저 인쇄 기능
- **로딩 및 에러 처리**: 사용자 친화적 메시지

### 6. 상세 정보 제공
#### 납부 정보 탭 (기본)
- 입금 계좌 정보 (은행명, 계좌번호, 예금주)
- 계좌 복사 버튼
- 미납 내역 상세 (있을 경우)
- 납부 안내사항

#### 요금 상세 탭
- 당월/전월 요금 비교 테이블
- 항목별 증감액 표시
- 모바일 전용 전월 비교 카드

#### 검침 정보 탭
- 전월/당월 지침
- 사용량 계산
- 검침일 안내

#### 건물 전체 탭
- 한전 계약 정보
- 계약 종별 및 전력
- 건물 총 청구액 및 사용량
- 요금 구성 내역

## 기술적 구현 사항

### 파일 구조
```
app/
├── api/
│   └── my/
│       └── bills/
│           └── [id]/
│               └── route.ts  (신규 - 사용자 청구서 API)
└── my/
    └── bills/
        ├── page.tsx        (수정 - 목록 페이지)
        └── [id]/
            └── page.tsx    (전면 개편 - 상세 페이지)
```

### 주요 기능
1. **보안**: 세션 기반 인증, 본인 호실만 조회 가능
2. **데이터 처리**:
   - 금액 포맷팅 (천 단위 구분, 소수점 제거)
   - 날짜 포맷팅 (한국식)
   - 전월 대비 계산
3. **상태 관리**: React useState로 탭 전환 및 복사 상태 관리
4. **비동기 처리**: useEffect로 데이터 로딩

## 성과
✅ 데이터베이스 스키마와 코드 동기화
✅ 사용자 친화적인 청구서 상세 페이지 구현
✅ 모바일 최적화된 반응형 디자인
✅ 관리자 페이지와 동일한 수준의 정보 제공
✅ 계좌 복사 등 편의 기능 추가
✅ 납부 정보를 기본 탭으로 설정하여 사용성 개선

## 추가 작업 내역 (2025-01-17 업데이트)

### 7. NaN 금액 표시 문제 수정
- **문제점**:
  - `total_amount`가 null일 때 Math.floor() 적용 시 NaN 표시
  - 청구서 목록 페이지의 요약 카드에서 "NaN원" 표시

- **수정 내용**:
  1. **`/my/bills/page.tsx`**:
     - reduce 함수에서 null 처리: `sum + (bill.total_amount || 0)`
     - 표시 시 NaN 체크: `(!totalAmount || isNaN(totalAmount) ? 0 : Math.floor(totalAmount))`

  2. **`/my/page.tsx`**:
     - totalUnpaid 계산 시 null 대체: `sum + (bill.total_amount || 0)`

  3. **`/my/bills/[id]/page.tsx`**:
     - formatCurrency 함수 개선:
     ```typescript
     if (!amount || isNaN(amount)) return '0';
     return Math.floor(amount).toLocaleString();
     ```

  4. **`/dashboard/bills/[id]/page.tsx`**:
     - 모든 금액 표시에 null 체크 추가
     - 예: `(unit.totalAmount ? Math.floor(unit.totalAmount) : 0).toLocaleString()`

  5. **`/dashboard/bills/[id]/units/[unitId]/page.tsx`**:
     - formatCurrency 함수에 null/NaN 처리 추가

- **결과**:
  - 모든 금액이 null/undefined/NaN일 경우 0원으로 표시
  - 사용자 친화적인 금액 표시

### 8. 납부기한 필드 매핑 확인
- **데이터베이스 매핑**:
  - 테이블: `unit_bills`
  - 컬럼: `due_date`
  - 사용 위치: 대시보드 및 청구서 목록 페이지

## 다음 단계
- PDF 다운로드 기능 구현
- 이메일 발송 기능 추가
- 인쇄 전용 레이아웃 페이지 구현
- 납부 완료 처리 기능 추가