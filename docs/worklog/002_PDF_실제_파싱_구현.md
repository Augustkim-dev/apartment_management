# 작업 로그: PDF 실제 파싱 구현

## 작업 일자
2025-01-15

## 작업 목표
샘플 데이터 대신 실제 한전 전기요금 고지서 PDF에서 데이터를 추출하는 파서 구현

## 이전 상황
- `pdf-parser-simple.ts`가 샘플 데이터만 반환하고 있었음
- 실제 PDF 파일 파싱이 필요한 상황
- 고객의 실제 PDF 파일 (7월 전기세(아르노빌리지).pdf) 제공됨

## 주요 작업 내용

### 1. PDF 분석
- 실제 한전 고지서 구조 분석
- 계약종별: 일반용(을)고압A (산업용/상업용)
- 시간대별 요금제 적용 (심야/주간/저녁)

### 2. 라이브러리 선택
- **unpdf** 라이브러리 선택
  - Vercel 서버리스 환경 최적화
  - PDF.js 기반 (v5.4.54)
  - Worker 문제 자동 해결
  - 한글 Unicode 지원

```bash
npm install unpdf
```

### 3. 데이터 구조 확장 (types/bill.ts)
```typescript
export interface KepcoInvoiceData {
  // 계약 정보 (신규)
  contractType?: string;         // 계약종별
  contractPower?: number;        // 계약전력
  appliedPower?: number;         // 요금적용전력
  
  // 시간대별 사용량 (신규)
  usageByTime?: {
    night: number;              // 심야(경부하)
    day: number;                // 주간(중간부하)
    evening: number;            // 저녁(최대부하)
  };
  
  // 추가 요금 항목
  powerFactorFee?: number;      // 역률요금
  powerFeeDetails?: {           // 전력량요금 상세
    night: number;
    day: number;
    evening: number;
  };
  
  // 기존 필드들...
}
```

### 4. 파서 구현 (kepco-invoice-parser.ts)

#### 핵심 추출 패턴
```typescript
// 청구 연월 (요금계산내역25년07월)
const yearMatch = firstLine.match(/(\d{2})년/);
const monthMatch = firstLine.match(/(\d{2})월/);

// 시간대별 사용량
/사용량\s+([\d,]+)\s+([\d,]+)\s+([\d,]+)\s+\d+/

// 요금 항목들
/기본요금\s+([\d,]+)/
/전력량요금\s+([\d,]+)/
/기후환경요금\s+([\d,]+)/
/연료비조정액\s+([-\d,]+)/
/역률요금\s+([-\d,]+)/
/부가가치세\s+([\d,]+)/
/전력기금\s+([\d,]+)/
/청구금액\s+([\d,]+)/
```

#### 주요 기능
- unpdf를 사용한 텍스트 추출
- 정규식 패턴 매칭
- 숫자 포맷 처리 (콤마 제거)
- 음수값 처리 (역률요금)
- 데이터 검증 (합계 확인)

### 5. 테스트 결과

#### 성공적으로 추출된 데이터
| 항목 | 추출값 | 실제값 | 상태 |
|------|--------|--------|------|
| 청구 연월 | 2025년 7월 | 2025년 7월 | ✅ |
| 계약전력 | 700 kW | 700 kW | ✅ |
| 요금적용전력 | 168 kW | 168 kW | ✅ |
| 총 사용량 | 25,231 kWh | 25,231 kWh | ✅ |
| 심야 사용량 | 12,299 kWh | 12,299 kWh | ✅ |
| 주간 사용량 | 8,643 kWh | 8,643 kWh | ✅ |
| 저녁 사용량 | 4,289 kWh | 4,289 kWh | ✅ |
| 기본요금 | 1,397,760원 | 1,397,760원 | ✅ |
| 전력량요금 | 3,238,894원 | 3,238,894원 | ✅ |
| 기후환경요금 | 227,079원 | 227,079원 | ✅ |
| 연료비조정액 | 126,155원 | 126,155원 | ✅ |
| 역률요금 | -13,977원 | -13,977원 | ✅ |
| 부가가치세 | 497,591원 | 497,591원 | ✅ |
| 전력기금 | 151,760원 | 151,760원 | ✅ |
| 원단위절사 | -2원 | -2원 | ✅ |
| 청구금액 | 5,625,260원 | 5,625,260원 | ✅ |

### 6. 문제 해결 과정

#### 문제 1: 청구 연월 추출 실패
- 원인: 텍스트가 공백 없이 붙어있음 ("요금계산내역25년07월")
- 해결: 더 유연한 패턴 매칭 적용

#### 문제 2: 총 사용량 추출 실패  
- 원인: "당월 25,231kWh" 패턴 매칭 실패
- 해결: 시간대별 사용량 합계를 대체값으로 사용

#### 문제 3: 시간대별 사용량 잘못된 매칭
- 원인: 복잡한 테이블 구조
- 해결: 정확한 패턴 위치 지정

### 7. 파일 변경 내역

#### 신규 파일
- `lib/parsers/kepco-invoice-parser.ts` - unpdf 기반 실제 파서
- `test-pdf-parser.ts` - 테스트 스크립트
- `test-kepco.pdf` - 테스트용 PDF 파일

#### 수정 파일
- `types/bill.ts` - 데이터 구조 확장
- `lib/parsers/pdf-parser-simple.ts` - 새 파서 export
- `package.json` - unpdf 의존성 추가

### 8. 테스트 방법
```bash
# 파서 테스트
npx tsx test-pdf-parser.ts

# 웹 애플리케이션 테스트
npm run dev
# http://localhost:3000/test-upload 접속
# PDF 파일 업로드
```

## 다음 단계
1. ✅ PDF 실제 파싱 구현 완료
2. ⏳ 계산 엔진 구현 (Phase 3)
   - 호실별 요금 비례 배분
   - 각 요금 항목별 계산
3. ⏳ 대시보드 UI 구현 (Phase 4)
4. ⏳ 인증 시스템 구현 (Phase 5)
5. ⏳ Vercel 배포 (Phase 6)

## 성과
- 실제 PDF에서 모든 필수 데이터 추출 성공
- 고객이 요청한 8개 핵심 항목 모두 정확히 추출
  - 기본료, 전력량요금, 기후환경요금, 연료비조정액
  - 역률요금, 금액합계, 부가세, 전력기금
- 시간대별 사용량 추가 추출로 더 정밀한 계산 가능

## 참고사항
- unpdf는 서버리스 환경에 최적화되어 Vercel 배포 시 문제없음
- PDF 구조가 변경되어도 패턴 조정으로 대응 가능
- 추출된 데이터는 데이터베이스에 저장되어 이력 관리됨