# 025. 수동 데이터 입력 페이지 추가

## 작업 일자
2026-02-11

## 작업 개요
한전 청구서 PDF 파싱 실패 또는 호실별 사용량 Excel 업로드 실패 시, 수동으로 데이터를 입력할 수 있는 페이지를 추가. 기존에 업로드된 데이터도 연/월 선택으로 불러와서 수정 가능.

---

## 배경

기존 데이터 업로드 페이지(`/dashboard/upload`)에서는 한전 청구서 PDF와 호실별 사용량 Excel을 파일로만 업로드할 수 있었다. PDF 파싱이 실패하거나 파일이 없는 경우, 수동으로 데이터를 입력하여 `parsed_pdf_data`와 `parsed_excel_data` 테이블에 저장할 방법이 없었다.

### 요구사항
- 한전 청구서 요금 데이터를 폼으로 수동 입력하여 `parsed_pdf_data` 테이블에 저장
- 호실별 사용량 데이터를 폼으로 수동 입력하여 `parsed_excel_data` 테이블에 저장
- 특정 연/월을 선택하여 기존 데이터를 불러와 수정 가능
- 기존 업로드 페이지에서 수동 입력 페이지로 이동할 수 있는 링크 제공

---

## 신규 파일

### 1. 수동 데이터 입력 페이지 (`app/dashboard/data-entry/page.tsx`)

탭 2개로 구성된 메인 페이지:

**공통 상단 UI:**
- 연도/월 선택 (select)
- "기존 데이터 불러오기" 버튼 → 해당 월 데이터가 있으면 폼에 자동 채움
- 상태 배지: "신규 입력" (초록) 또는 "수정 모드 (ID: XX)" (노랑)

**탭 1 - 한전 청구서 데이터:**
- 청구기간 (시작일/종료일)
- 총 사용량 (kWh)
- 9개 요금 항목: 기본요금, 전력량요금, 기후환경요금, 연료비조정액, 역률요금, 부가가치세, 전력산업기반기금, TV수신료, 원단위절사
- 자동 합계 실시간 계산
- 총 청구액 (수동 입력 가능, 자동 합계와 차이 표시)
- 계약 정보 (계약종별, 계약전력)

**탭 2 - 호실별 사용량 데이터:**
- 48개 호실(201~416)을 층별(2층/3층/4층) 3열 레이아웃
- 각 호실별 사용량(kWh) 입력
- 하단 실시간 합계: 입력 호실 수, 총 사용량, 평균 사용량

### 2. API 엔드포인트 - parsed-pdf-data

#### `app/api/parsed-pdf-data/route.ts`
- **GET** `?year=2025&month=7` → `billing_period_start/end` 기준으로 해당 월 데이터 조회
- **POST** → 수동 입력 데이터를 `parsed_pdf_data`에 INSERT (`file_name`은 "수동입력_2025년_7월" 형식, `file_hash`는 null)

#### `app/api/parsed-pdf-data/[id]/route.ts`
- **GET** → 특정 ID의 `parsed_pdf_data` 조회
- **PUT** → 기존 레코드의 요금 항목 및 메타데이터 UPDATE

### 3. API 엔드포인트 - parsed-excel-data

#### `app/api/parsed-excel-data/route.ts`
- **GET** `?year=2025&month=7` → `file_name`에서 연/월 패턴 매칭으로 조회
- **POST** → 수동 입력 `unit_data`를 `parsed_excel_data`에 INSERT (총 호실 수, 총 사용량, 평균 자동 계산)

#### `app/api/parsed-excel-data/[id]/route.ts`
- **GET** → 특정 ID의 `parsed_excel_data` 조회 (`unit_data` JSON 파싱 포함)
- **PUT** → 기존 레코드의 `unit_data`, 통계 정보 UPDATE

---

## 수정 파일

### 4. 사이드바 네비게이션 (`app/dashboard/layout.tsx`)

`PencilSquareIcon` import 추가 및 navigation 배열에 메뉴 항목 추가:

```typescript
{ name: '수동 데이터 입력', href: '/dashboard/data-entry', icon: PencilSquareIcon },
```

"데이터 업로드" 바로 아래에 위치.

### 5. 업로드 페이지 (`app/dashboard/upload/page.tsx`)

`Link` import 추가 및 페이지 상단 설명 아래에 수동 입력 안내 링크 추가:

```tsx
<p className="mt-2 text-sm text-blue-600">
  파일 업로드가 안되나요?{' '}
  <Link href="/dashboard/data-entry" className="font-medium underline hover:text-blue-800">
    수동으로 입력하기
  </Link>
</p>
```

---

## 사용 방법

### 신규 데이터 입력
1. 사이드바에서 "수동 데이터 입력" 클릭
2. 연도/월 선택
3. 한전 청구서 탭에서 요금 항목 입력 → "저장"
4. 호실별 사용량 탭으로 전환 → 각 호실 사용량 입력 → "저장"

### 기존 데이터 수정
1. 수정하려는 연도/월 선택
2. "기존 데이터 불러오기" 클릭 → 폼에 기존 값 자동 채움
3. 상태 배지가 "수정 모드 (ID: XX)"로 변경됨
4. 값 수정 후 "수정 저장" 클릭

---

## 기술 스택
- **프론트엔드**: Next.js App Router, React useState/useMemo/useCallback, Tailwind CSS
- **아이콘**: @heroicons/react (PencilSquareIcon, DocumentTextIcon, TableCellsIcon, MagnifyingGlassIcon, ArrowPathIcon)
- **알림**: react-hot-toast
- **DB**: MySQL (기존 `parsed_pdf_data`, `parsed_excel_data` 테이블 활용)
- **DB 유틸리티**: `lib/db-utils.ts`의 `query`, `execute` 함수 사용
