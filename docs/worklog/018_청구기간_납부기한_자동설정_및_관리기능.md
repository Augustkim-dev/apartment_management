# Worklog 018: 청구기간 및 납부기한 자동 설정 및 관리 기능 추가

**날짜**: 2025-10-31
**작업자**: Claude Code
**소요 시간**: 약 2.5시간
**난이도**: ⭐⭐⭐☆☆

## 📋 작업 개요

월별 청구서의 청구기간과 납부기한을 자동으로 설정하고, 관리자가 수정할 수 있는 기능을 추가했습니다. 또한 사용자 화면에서 납부기한이 1970-01-01로 표시되던 버그를 해결했습니다.

## 🎯 작업 목표

1. **청구기간 기본값 변경**: 해당 월 → 다음 달 (+1 month)
2. **납부기한 자동 설정**: 청구기간 종료일 + 10일로 자동 계산
3. **관리자 수정 기능**: 청구기간과 납부기한을 UI에서 수정 가능
4. **사용자 화면 버그 수정**: due_date NULL로 인한 1970-01-01 표시 문제 해결

## 🔧 구현 내용

### Phase 1: 청구기간 기본값 변경 (5분)

**파일**: `app/api/bills/route.ts`

```typescript
// BEFORE: 해당 월 1일 ~ 해당 월 마지막날
const defaultStart = new Date(billYear, billMonth - 1, 1);
const defaultEnd = new Date(billYear, billMonth, 0);

// AFTER: 다음 달 1일 ~ 다음 달 마지막날
const defaultStart = new Date(billYear, billMonth, 1);
const defaultEnd = new Date(billYear, billMonth + 1, 0);
```

**효과**:
- 1월 청구서: 1/1~1/31 → 2/1~2/28
- 12월 청구서: 12/1~12/31 → 다음해 1/1~1/31

### Phase 2: 납부기한 자동 설정 (30분)

**파일**: `app/api/bills/route.ts`

**추가된 로직**:
```typescript
// 납부기한 기본값 계산 (청구기간 종료일 + 10일)
const calculateDefaultDueDate = (billingEndDate: Date): Date => {
  const dueDate = new Date(billingEndDate);
  dueDate.setDate(dueDate.getDate() + 10);
  return dueDate;
};

// 납부기한 처리
let finalDueDate: string;
if (dueDate) {
  finalDueDate = formatDateForMySQL(dueDate);
} else {
  const endDate = billingPeriodEnd
    ? new Date(billingPeriodEnd)
    : new Date(billYear, billMonth + 1, 0);
  finalDueDate = formatDateForMySQL(calculateDefaultDueDate(endDate).toISOString());
}
```

**INSERT 문 수정**:
```typescript
INSERT INTO monthly_bills (
  ...,
  billing_period_start, billing_period_end, due_date
) VALUES (?, ?, ?, ?, ..., ?, ?, ?)
```

### Phase 3: unit_bills에 due_date 전파 (20분)

**파일**: `lib/services/unit-bills.service.ts`

**변경사항**:
1. monthly_bills에서 due_date 조회
```typescript
const [monthlyBills] = await conn.execute<RowDataPacket[]>(
  'SELECT due_date FROM monthly_bills WHERE id = ?',
  [monthlyBillId]
);

const dueDate = monthlyBills.length > 0 ? monthlyBills[0].due_date : null;
```

2. unit_bills INSERT에 due_date 추가
```typescript
INSERT INTO unit_bills (
  ...,
  total_amount, payment_status, due_date, notes
) VALUES (?, ?, ..., ?, ?, ?, ?)
```

**효과**:
- 사용자 화면(/my, /my/bills)에서 정상적인 납부기한 표시
- 1970-01-01 버그 완전 해결

### Phase 4: 관리자 수정 UI (1.5시간)

#### 4-1. PATCH API 엔드포인트

**파일**: `app/api/bills/[id]/billing-info/route.ts` (신규)

```typescript
export async function PATCH(request: Request, { params }) {
  const { billingPeriodStart, billingPeriodEnd, dueDate } = await request.json();

  // 입력 검증
  if (!billingPeriodStart || !billingPeriodEnd || !dueDate) {
    return NextResponse.json({ error: '필수 항목 누락' }, { status: 400 });
  }

  // monthly_bills 업데이트
  await execute(
    `UPDATE monthly_bills
     SET billing_period_start = ?,
         billing_period_end = ?,
         due_date = ?
     WHERE id = ?`,
    [formattedStartDate, formattedEndDate, formattedDueDate, billId]
  );

  // unit_bills의 due_date도 함께 업데이트
  await execute(
    `UPDATE unit_bills
     SET due_date = ?
     WHERE monthly_bill_id = ?`,
    [formattedDueDate, billId]
  );

  return NextResponse.json({ success: true });
}
```

#### 4-2. 프론트엔드 UI

**파일**: `app/dashboard/bills/[id]/page.tsx`

**추가된 요소**:
1. **인터페이스 업데이트**
```typescript
interface BillDetail {
  ...,
  dueDate?: string;
}
```

2. **상태 관리**
```typescript
const [isEditModalOpen, setIsEditModalOpen] = useState(false);
const [editFormData, setEditFormData] = useState({
  billingPeriodStart: '',
  billingPeriodEnd: '',
  dueDate: '',
});
```

3. **핸들러 함수**
```typescript
const handleOpenEditModal = () => {
  setEditFormData({
    billingPeriodStart: formatForInput(bill.billingPeriodStart),
    billingPeriodEnd: formatForInput(bill.billingPeriodEnd),
    dueDate: bill.dueDate ? formatForInput(bill.dueDate) : '',
  });
  setIsEditModalOpen(true);
};

const handleSaveBillingInfo = async () => {
  const response = await fetch(`/api/bills/${billId}/billing-info`, {
    method: 'PATCH',
    body: JSON.stringify(editFormData),
  });
  // 성공 시 toast 표시 및 데이터 새로고침
};
```

4. **UI 컴포넌트**
- 헤더에 "청구정보 수정" 버튼 추가
- 모달 다이얼로그 (3개 날짜 입력 필드)
- 청구서 상세 페이지에 납부기한 표시

```typescript
{bill.dueDate && (
  <p className="text-sm text-gray-500 mt-1">
    납부기한: {formatDate(bill.dueDate)}
  </p>
)}
```

#### 4-3. GET API 업데이트

**파일**: `app/api/bills/[id]/route.ts`

```typescript
return NextResponse.json({
  ...,
  dueDate: bill.due_date,  // 추가
  ...
});
```

## 📊 데이터 흐름

```
POST /api/bills (청구서 생성)
  ↓
청구기간 자동 계산 (다음 달 1일~마지막날)
  ↓
납부기한 자동 계산 (청구기간 종료 + 10일)
  ↓
monthly_bills INSERT (due_date 포함)
  ↓
POST /api/calculate (호실별 계산)
  ↓
monthly_bills에서 due_date 조회
  ↓
unit_bills INSERT (due_date 전파)
  ↓
사용자 화면 표시 (/my, /my/bills)
```

## 🧪 테스트 시나리오

### 시나리오 1: 새 청구서 생성
1. POST /api/bills로 2025년 1월 청구서 생성
2. 청구기간: 2025-02-01 ~ 2025-02-28 (자동 설정)
3. 납부기한: 2025-03-10 (자동 계산)
4. monthly_bills에 저장 확인

### 시나리오 2: 호실별 계산 및 due_date 전파
1. 월별 청구서 생성 (due_date: 2025-03-10)
2. POST /api/calculate로 호실별 계산 실행
3. unit_bills 60개 레코드 생성
4. 모든 레코드의 due_date = 2025-03-10 확인

### 시나리오 3: 관리자 수정
1. 청구서 상세 페이지 접속
2. "청구정보 수정" 버튼 클릭
3. 모달에서 날짜 수정
   - 청구기간 시작: 2025-02-05
   - 청구기간 종료: 2025-03-04
   - 납부기한: 2025-03-15
4. 저장 버튼 클릭
5. monthly_bills 업데이트 확인
6. unit_bills 60개 모두 due_date = 2025-03-15로 업데이트 확인

### 시나리오 4: 사용자 화면 표시
1. 일반 사용자로 로그인
2. /my (대시보드) 접속
3. 납부기한: 2025-03-15 정상 표시 확인
4. /my/bills (청구서 목록) 접속
5. 각 청구서의 납부기한 정상 표시 확인

## 📈 성능 영향

- **쿼리 추가**: unit_bills 저장 시 monthly_bills 조회 1회 추가
- **데이터베이스 영향**: 미미함 (단일 SELECT 쿼리)
- **사용자 경험**: 개선 (자동 계산으로 입력 간소화)
- **관리 편의성**: 대폭 향상 (UI에서 직접 수정 가능)

## 🐛 해결된 버그

### 버그 #1: 사용자 화면 due_date 1970-01-01 표시
**원인**:
- unit_bills.due_date 컬럼은 존재하나 NULL 값
- JavaScript `new Date(null)` → 1970-01-01

**해결**:
- unit_bills 생성 시 monthly_bills.due_date 전파
- 모든 신규 레코드에 정상 due_date 설정

### 버그 #2: 청구기간과 사용 기간 불일치
**원인**:
- 1월 청구서가 1월 사용량 기준
- 실제로는 다음 달(2월) 사용량을 청구해야 함

**해결**:
- 청구기간 기본값을 +1 month로 변경
- 1월 청구서 = 2월 1일~28일 사용량

## 💡 주요 기술 결정

### 결정 1: 납부기한 기본값 = 청구기간 종료 + 10일
**이유**:
- 일반적인 공과금 납부 기간 (약 10일)
- 관리자 판단에 따라 UI에서 조정 가능

### 결정 2: monthly_bills 수정 시 unit_bills 자동 업데이트
**이유**:
- 데이터 일관성 보장
- 관리자가 개별 unit_bills 수정 불필요
- 사용자 화면에 즉시 반영

### 결정 3: 날짜 형식 변환 함수 재사용
```typescript
const formatDateForMySQL = (dateStr: string): string => {
  return new Date(dateStr).toISOString().slice(0, 19).replace('T', ' ');
};
```
**이유**:
- ISO 8601 → MySQL DATETIME 형식 변환
- API 엔드포인트에서 재사용

## 📝 변경된 파일 목록

1. **app/api/bills/route.ts** (수정)
   - 청구기간 기본값 변경
   - 납부기한 자동 계산 로직 추가
   - INSERT 문에 due_date 추가

2. **lib/services/unit-bills.service.ts** (수정)
   - monthly_bills에서 due_date 조회
   - unit_bills INSERT에 due_date 전파

3. **app/api/bills/[id]/billing-info/route.ts** (신규)
   - PATCH 엔드포인트 구현
   - monthly_bills + unit_bills 동시 업데이트

4. **app/dashboard/bills/[id]/page.tsx** (수정)
   - BillDetail 인터페이스에 dueDate 추가
   - 청구정보 수정 모달 UI 추가
   - 납부기한 표시 추가

5. **app/api/bills/[id]/route.ts** (수정)
   - GET 응답에 dueDate 포함

## 🎓 배운 점

1. **날짜 계산의 복잡성**
   - JavaScript Date의 month는 0-based (0 = 1월)
   - MySQL DATE는 1-based
   - 시간대 고려 필요 (ISO string 변환)

2. **데이터 일관성 유지**
   - 부모 테이블(monthly_bills) 수정 시
   - 자식 테이블(unit_bills) 자동 업데이트 필요
   - 트랜잭션 불필요 (읽기 후 쓰기 패턴)

3. **UI/UX 개선**
   - 자동 계산으로 사용자 입력 최소화
   - 관리자에게는 수정 권한 제공
   - 모달 vs 인라인 편집 선택

## 🔮 향후 개선 사항

### 단기 (1주일 내)
- [ ] 기존 청구서들의 due_date 일괄 업데이트 SQL 스크립트 작성
- [ ] 납부기한 경과 시 자동 연체 처리 (Cron Job)
- [ ] 청구기간/납부기한 검증 로직 강화 (시작일 < 종료일 < 납부기한)

### 중기 (1개월 내)
- [ ] 청구서 목록 페이지에 청구기간/납부기한 표시
- [ ] 납부기한 임박 알림 기능 (D-3, D-1)
- [ ] 청구기간별 통계 차트 추가

### 장기 (3개월 내)
- [ ] 청구기간 템플릿 기능 (매월 동일 패턴 자동 적용)
- [ ] 납부기한 연장 신청 기능 (사용자 요청 → 관리자 승인)
- [ ] 청구기간/납부기한 이력 관리 (변경 로그)

## 📚 관련 문서

- [Worklog 001: 데이터베이스 설계](./001_데이터베이스_설계.md)
- [Worklog 015: 납부안내 순서관리 기능 추가](./015_납부안내_순서관리_기능_추가.md)
- [PRD: 전기료 분배 시스템](../전기료_분배_시스템.prd)

## 🏷️ 태그

`#billing-period` `#due-date` `#auto-calculation` `#admin-ui` `#bug-fix` `#date-handling` `#mysql`

---

**커밋 해시**: be376e9efff108e23c87d139463d0bbc3e97dd90
**PR**: N/A (직접 main 브랜치 커밋)
**검토자**: -
**승인자**: -
