# Worklog 018: ì²­êµ¬ê¸°ê°„ ë° ë‚©ë¶€ê¸°í•œ ìë™ ì„¤ì • ë° ê´€ë¦¬ ê¸°ëŠ¥ ì¶”ê°€

**ë‚ ì§œ**: 2025-10-31
**ì‘ì—…ì**: Claude Code
**ì†Œìš” ì‹œê°„**: ì•½ 2.5ì‹œê°„
**ë‚œì´ë„**: â­â­â­â˜†â˜†

## ğŸ“‹ ì‘ì—… ê°œìš”

ì›”ë³„ ì²­êµ¬ì„œì˜ ì²­êµ¬ê¸°ê°„ê³¼ ë‚©ë¶€ê¸°í•œì„ ìë™ìœ¼ë¡œ ì„¤ì •í•˜ê³ , ê´€ë¦¬ìê°€ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. ë˜í•œ ì‚¬ìš©ì í™”ë©´ì—ì„œ ë‚©ë¶€ê¸°í•œì´ 1970-01-01ë¡œ í‘œì‹œë˜ë˜ ë²„ê·¸ë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤.

## ğŸ¯ ì‘ì—… ëª©í‘œ

1. **ì²­êµ¬ê¸°ê°„ ê¸°ë³¸ê°’ ë³€ê²½**: í•´ë‹¹ ì›” â†’ ë‹¤ìŒ ë‹¬ (+1 month)
2. **ë‚©ë¶€ê¸°í•œ ìë™ ì„¤ì •**: ì²­êµ¬ê¸°ê°„ ì¢…ë£Œì¼ + 10ì¼ë¡œ ìë™ ê³„ì‚°
3. **ê´€ë¦¬ì ìˆ˜ì • ê¸°ëŠ¥**: ì²­êµ¬ê¸°ê°„ê³¼ ë‚©ë¶€ê¸°í•œì„ UIì—ì„œ ìˆ˜ì • ê°€ëŠ¥
4. **ì‚¬ìš©ì í™”ë©´ ë²„ê·¸ ìˆ˜ì •**: due_date NULLë¡œ ì¸í•œ 1970-01-01 í‘œì‹œ ë¬¸ì œ í•´ê²°

## ğŸ”§ êµ¬í˜„ ë‚´ìš©

### Phase 1: ì²­êµ¬ê¸°ê°„ ê¸°ë³¸ê°’ ë³€ê²½ (5ë¶„)

**íŒŒì¼**: `app/api/bills/route.ts`

```typescript
// BEFORE: í•´ë‹¹ ì›” 1ì¼ ~ í•´ë‹¹ ì›” ë§ˆì§€ë§‰ë‚ 
const defaultStart = new Date(billYear, billMonth - 1, 1);
const defaultEnd = new Date(billYear, billMonth, 0);

// AFTER: ë‹¤ìŒ ë‹¬ 1ì¼ ~ ë‹¤ìŒ ë‹¬ ë§ˆì§€ë§‰ë‚ 
const defaultStart = new Date(billYear, billMonth, 1);
const defaultEnd = new Date(billYear, billMonth + 1, 0);
```

**íš¨ê³¼**:
- 1ì›” ì²­êµ¬ì„œ: 1/1~1/31 â†’ 2/1~2/28
- 12ì›” ì²­êµ¬ì„œ: 12/1~12/31 â†’ ë‹¤ìŒí•´ 1/1~1/31

### Phase 2: ë‚©ë¶€ê¸°í•œ ìë™ ì„¤ì • (30ë¶„)

**íŒŒì¼**: `app/api/bills/route.ts`

**ì¶”ê°€ëœ ë¡œì§**:
```typescript
// ë‚©ë¶€ê¸°í•œ ê¸°ë³¸ê°’ ê³„ì‚° (ì²­êµ¬ê¸°ê°„ ì¢…ë£Œì¼ + 10ì¼)
const calculateDefaultDueDate = (billingEndDate: Date): Date => {
  const dueDate = new Date(billingEndDate);
  dueDate.setDate(dueDate.getDate() + 10);
  return dueDate;
};

// ë‚©ë¶€ê¸°í•œ ì²˜ë¦¬
let finalDueDate: string;
if (dueDate) {
  finalDueDate = formatDateForMySQL(dueDate);
} else {
  const endDate = billingPeriodEnd
    ? new Date(billingPeriodEnd)
    : new Date(billYear, billMonth + 1, 0);
  finalDueDate = formatDateForMySQL(calculateDefaultDueDate(endDate).toISOString());
}
```

**INSERT ë¬¸ ìˆ˜ì •**:
```typescript
INSERT INTO monthly_bills (
  ...,
  billing_period_start, billing_period_end, due_date
) VALUES (?, ?, ?, ?, ..., ?, ?, ?)
```

### Phase 3: unit_billsì— due_date ì „íŒŒ (20ë¶„)

**íŒŒì¼**: `lib/services/unit-bills.service.ts`

**ë³€ê²½ì‚¬í•­**:
1. monthly_billsì—ì„œ due_date ì¡°íšŒ
```typescript
const [monthlyBills] = await conn.execute<RowDataPacket[]>(
  'SELECT due_date FROM monthly_bills WHERE id = ?',
  [monthlyBillId]
);

const dueDate = monthlyBills.length > 0 ? monthlyBills[0].due_date : null;
```

2. unit_bills INSERTì— due_date ì¶”ê°€
```typescript
INSERT INTO unit_bills (
  ...,
  total_amount, payment_status, due_date, notes
) VALUES (?, ?, ..., ?, ?, ?, ?)
```

**íš¨ê³¼**:
- ì‚¬ìš©ì í™”ë©´(/my, /my/bills)ì—ì„œ ì •ìƒì ì¸ ë‚©ë¶€ê¸°í•œ í‘œì‹œ
- 1970-01-01 ë²„ê·¸ ì™„ì „ í•´ê²°

### Phase 4: ê´€ë¦¬ì ìˆ˜ì • UI (1.5ì‹œê°„)

#### 4-1. PATCH API ì—”ë“œí¬ì¸íŠ¸

**íŒŒì¼**: `app/api/bills/[id]/billing-info/route.ts` (ì‹ ê·œ)

```typescript
export async function PATCH(request: Request, { params }) {
  const { billingPeriodStart, billingPeriodEnd, dueDate } = await request.json();

  // ì…ë ¥ ê²€ì¦
  if (!billingPeriodStart || !billingPeriodEnd || !dueDate) {
    return NextResponse.json({ error: 'í•„ìˆ˜ í•­ëª© ëˆ„ë½' }, { status: 400 });
  }

  // monthly_bills ì—…ë°ì´íŠ¸
  await execute(
    `UPDATE monthly_bills
     SET billing_period_start = ?,
         billing_period_end = ?,
         due_date = ?
     WHERE id = ?`,
    [formattedStartDate, formattedEndDate, formattedDueDate, billId]
  );

  // unit_billsì˜ due_dateë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
  await execute(
    `UPDATE unit_bills
     SET due_date = ?
     WHERE monthly_bill_id = ?`,
    [formattedDueDate, billId]
  );

  return NextResponse.json({ success: true });
}
```

#### 4-2. í”„ë¡ íŠ¸ì—”ë“œ UI

**íŒŒì¼**: `app/dashboard/bills/[id]/page.tsx`

**ì¶”ê°€ëœ ìš”ì†Œ**:
1. **ì¸í„°í˜ì´ìŠ¤ ì—…ë°ì´íŠ¸**
```typescript
interface BillDetail {
  ...,
  dueDate?: string;
}
```

2. **ìƒíƒœ ê´€ë¦¬**
```typescript
const [isEditModalOpen, setIsEditModalOpen] = useState(false);
const [editFormData, setEditFormData] = useState({
  billingPeriodStart: '',
  billingPeriodEnd: '',
  dueDate: '',
});
```

3. **í•¸ë“¤ëŸ¬ í•¨ìˆ˜**
```typescript
const handleOpenEditModal = () => {
  setEditFormData({
    billingPeriodStart: formatForInput(bill.billingPeriodStart),
    billingPeriodEnd: formatForInput(bill.billingPeriodEnd),
    dueDate: bill.dueDate ? formatForInput(bill.dueDate) : '',
  });
  setIsEditModalOpen(true);
};

const handleSaveBillingInfo = async () => {
  const response = await fetch(`/api/bills/${billId}/billing-info`, {
    method: 'PATCH',
    body: JSON.stringify(editFormData),
  });
  // ì„±ê³µ ì‹œ toast í‘œì‹œ ë° ë°ì´í„° ìƒˆë¡œê³ ì¹¨
};
```

4. **UI ì»´í¬ë„ŒíŠ¸**
- í—¤ë”ì— "ì²­êµ¬ì •ë³´ ìˆ˜ì •" ë²„íŠ¼ ì¶”ê°€
- ëª¨ë‹¬ ë‹¤ì´ì–¼ë¡œê·¸ (3ê°œ ë‚ ì§œ ì…ë ¥ í•„ë“œ)
- ì²­êµ¬ì„œ ìƒì„¸ í˜ì´ì§€ì— ë‚©ë¶€ê¸°í•œ í‘œì‹œ

```typescript
{bill.dueDate && (
  <p className="text-sm text-gray-500 mt-1">
    ë‚©ë¶€ê¸°í•œ: {formatDate(bill.dueDate)}
  </p>
)}
```

#### 4-3. GET API ì—…ë°ì´íŠ¸

**íŒŒì¼**: `app/api/bills/[id]/route.ts`

```typescript
return NextResponse.json({
  ...,
  dueDate: bill.due_date,  // ì¶”ê°€
  ...
});
```

## ğŸ“Š ë°ì´í„° íë¦„

```
POST /api/bills (ì²­êµ¬ì„œ ìƒì„±)
  â†“
ì²­êµ¬ê¸°ê°„ ìë™ ê³„ì‚° (ë‹¤ìŒ ë‹¬ 1ì¼~ë§ˆì§€ë§‰ë‚ )
  â†“
ë‚©ë¶€ê¸°í•œ ìë™ ê³„ì‚° (ì²­êµ¬ê¸°ê°„ ì¢…ë£Œ + 10ì¼)
  â†“
monthly_bills INSERT (due_date í¬í•¨)
  â†“
POST /api/calculate (í˜¸ì‹¤ë³„ ê³„ì‚°)
  â†“
monthly_billsì—ì„œ due_date ì¡°íšŒ
  â†“
unit_bills INSERT (due_date ì „íŒŒ)
  â†“
ì‚¬ìš©ì í™”ë©´ í‘œì‹œ (/my, /my/bills)
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ìƒˆ ì²­êµ¬ì„œ ìƒì„±
1. POST /api/billsë¡œ 2025ë…„ 1ì›” ì²­êµ¬ì„œ ìƒì„±
2. ì²­êµ¬ê¸°ê°„: 2025-02-01 ~ 2025-02-28 (ìë™ ì„¤ì •)
3. ë‚©ë¶€ê¸°í•œ: 2025-03-10 (ìë™ ê³„ì‚°)
4. monthly_billsì— ì €ì¥ í™•ì¸

### ì‹œë‚˜ë¦¬ì˜¤ 2: í˜¸ì‹¤ë³„ ê³„ì‚° ë° due_date ì „íŒŒ
1. ì›”ë³„ ì²­êµ¬ì„œ ìƒì„± (due_date: 2025-03-10)
2. POST /api/calculateë¡œ í˜¸ì‹¤ë³„ ê³„ì‚° ì‹¤í–‰
3. unit_bills 60ê°œ ë ˆì½”ë“œ ìƒì„±
4. ëª¨ë“  ë ˆì½”ë“œì˜ due_date = 2025-03-10 í™•ì¸

### ì‹œë‚˜ë¦¬ì˜¤ 3: ê´€ë¦¬ì ìˆ˜ì •
1. ì²­êµ¬ì„œ ìƒì„¸ í˜ì´ì§€ ì ‘ì†
2. "ì²­êµ¬ì •ë³´ ìˆ˜ì •" ë²„íŠ¼ í´ë¦­
3. ëª¨ë‹¬ì—ì„œ ë‚ ì§œ ìˆ˜ì •
   - ì²­êµ¬ê¸°ê°„ ì‹œì‘: 2025-02-05
   - ì²­êµ¬ê¸°ê°„ ì¢…ë£Œ: 2025-03-04
   - ë‚©ë¶€ê¸°í•œ: 2025-03-15
4. ì €ì¥ ë²„íŠ¼ í´ë¦­
5. monthly_bills ì—…ë°ì´íŠ¸ í™•ì¸
6. unit_bills 60ê°œ ëª¨ë‘ due_date = 2025-03-15ë¡œ ì—…ë°ì´íŠ¸ í™•ì¸

### ì‹œë‚˜ë¦¬ì˜¤ 4: ì‚¬ìš©ì í™”ë©´ í‘œì‹œ
1. ì¼ë°˜ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸
2. /my (ëŒ€ì‹œë³´ë“œ) ì ‘ì†
3. ë‚©ë¶€ê¸°í•œ: 2025-03-15 ì •ìƒ í‘œì‹œ í™•ì¸
4. /my/bills (ì²­êµ¬ì„œ ëª©ë¡) ì ‘ì†
5. ê° ì²­êµ¬ì„œì˜ ë‚©ë¶€ê¸°í•œ ì •ìƒ í‘œì‹œ í™•ì¸

## ğŸ“ˆ ì„±ëŠ¥ ì˜í–¥

- **ì¿¼ë¦¬ ì¶”ê°€**: unit_bills ì €ì¥ ì‹œ monthly_bills ì¡°íšŒ 1íšŒ ì¶”ê°€
- **ë°ì´í„°ë² ì´ìŠ¤ ì˜í–¥**: ë¯¸ë¯¸í•¨ (ë‹¨ì¼ SELECT ì¿¼ë¦¬)
- **ì‚¬ìš©ì ê²½í—˜**: ê°œì„  (ìë™ ê³„ì‚°ìœ¼ë¡œ ì…ë ¥ ê°„ì†Œí™”)
- **ê´€ë¦¬ í¸ì˜ì„±**: ëŒ€í­ í–¥ìƒ (UIì—ì„œ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥)

## ğŸ› í•´ê²°ëœ ë²„ê·¸

### ë²„ê·¸ #1: ì‚¬ìš©ì í™”ë©´ due_date 1970-01-01 í‘œì‹œ
**ì›ì¸**:
- unit_bills.due_date ì»¬ëŸ¼ì€ ì¡´ì¬í•˜ë‚˜ NULL ê°’
- JavaScript `new Date(null)` â†’ 1970-01-01

**í•´ê²°**:
- unit_bills ìƒì„± ì‹œ monthly_bills.due_date ì „íŒŒ
- ëª¨ë“  ì‹ ê·œ ë ˆì½”ë“œì— ì •ìƒ due_date ì„¤ì •

### ë²„ê·¸ #2: ì²­êµ¬ê¸°ê°„ê³¼ ì‚¬ìš© ê¸°ê°„ ë¶ˆì¼ì¹˜
**ì›ì¸**:
- 1ì›” ì²­êµ¬ì„œê°€ 1ì›” ì‚¬ìš©ëŸ‰ ê¸°ì¤€
- ì‹¤ì œë¡œëŠ” ë‹¤ìŒ ë‹¬(2ì›”) ì‚¬ìš©ëŸ‰ì„ ì²­êµ¬í•´ì•¼ í•¨

**í•´ê²°**:
- ì²­êµ¬ê¸°ê°„ ê¸°ë³¸ê°’ì„ +1 monthë¡œ ë³€ê²½
- 1ì›” ì²­êµ¬ì„œ = 2ì›” 1ì¼~28ì¼ ì‚¬ìš©ëŸ‰

## ğŸ’¡ ì£¼ìš” ê¸°ìˆ  ê²°ì •

### ê²°ì • 1: ë‚©ë¶€ê¸°í•œ ê¸°ë³¸ê°’ = ì²­êµ¬ê¸°ê°„ ì¢…ë£Œ + 10ì¼
**ì´ìœ **:
- ì¼ë°˜ì ì¸ ê³µê³¼ê¸ˆ ë‚©ë¶€ ê¸°ê°„ (ì•½ 10ì¼)
- ê´€ë¦¬ì íŒë‹¨ì— ë”°ë¼ UIì—ì„œ ì¡°ì • ê°€ëŠ¥

### ê²°ì • 2: monthly_bills ìˆ˜ì • ì‹œ unit_bills ìë™ ì—…ë°ì´íŠ¸
**ì´ìœ **:
- ë°ì´í„° ì¼ê´€ì„± ë³´ì¥
- ê´€ë¦¬ìê°€ ê°œë³„ unit_bills ìˆ˜ì • ë¶ˆí•„ìš”
- ì‚¬ìš©ì í™”ë©´ì— ì¦‰ì‹œ ë°˜ì˜

### ê²°ì • 3: ë‚ ì§œ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜ ì¬ì‚¬ìš©
```typescript
const formatDateForMySQL = (dateStr: string): string => {
  return new Date(dateStr).toISOString().slice(0, 19).replace('T', ' ');
};
```
**ì´ìœ **:
- ISO 8601 â†’ MySQL DATETIME í˜•ì‹ ë³€í™˜
- API ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì¬ì‚¬ìš©

## ğŸ“ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡

1. **app/api/bills/route.ts** (ìˆ˜ì •)
   - ì²­êµ¬ê¸°ê°„ ê¸°ë³¸ê°’ ë³€ê²½
   - ë‚©ë¶€ê¸°í•œ ìë™ ê³„ì‚° ë¡œì§ ì¶”ê°€
   - INSERT ë¬¸ì— due_date ì¶”ê°€

2. **lib/services/unit-bills.service.ts** (ìˆ˜ì •)
   - monthly_billsì—ì„œ due_date ì¡°íšŒ
   - unit_bills INSERTì— due_date ì „íŒŒ

3. **app/api/bills/[id]/billing-info/route.ts** (ì‹ ê·œ)
   - PATCH ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
   - monthly_bills + unit_bills ë™ì‹œ ì—…ë°ì´íŠ¸

4. **app/dashboard/bills/[id]/page.tsx** (ìˆ˜ì •)
   - BillDetail ì¸í„°í˜ì´ìŠ¤ì— dueDate ì¶”ê°€
   - ì²­êµ¬ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ UI ì¶”ê°€
   - ë‚©ë¶€ê¸°í•œ í‘œì‹œ ì¶”ê°€

5. **app/api/bills/[id]/route.ts** (ìˆ˜ì •)
   - GET ì‘ë‹µì— dueDate í¬í•¨

## ğŸ“ ë°°ìš´ ì 

1. **ë‚ ì§œ ê³„ì‚°ì˜ ë³µì¡ì„±**
   - JavaScript Dateì˜ monthëŠ” 0-based (0 = 1ì›”)
   - MySQL DATEëŠ” 1-based
   - ì‹œê°„ëŒ€ ê³ ë ¤ í•„ìš” (ISO string ë³€í™˜)

2. **ë°ì´í„° ì¼ê´€ì„± ìœ ì§€**
   - ë¶€ëª¨ í…Œì´ë¸”(monthly_bills) ìˆ˜ì • ì‹œ
   - ìì‹ í…Œì´ë¸”(unit_bills) ìë™ ì—…ë°ì´íŠ¸ í•„ìš”
   - íŠ¸ëœì­ì…˜ ë¶ˆí•„ìš” (ì½ê¸° í›„ ì“°ê¸° íŒ¨í„´)

3. **UI/UX ê°œì„ **
   - ìë™ ê³„ì‚°ìœ¼ë¡œ ì‚¬ìš©ì ì…ë ¥ ìµœì†Œí™”
   - ê´€ë¦¬ìì—ê²ŒëŠ” ìˆ˜ì • ê¶Œí•œ ì œê³µ
   - ëª¨ë‹¬ vs ì¸ë¼ì¸ í¸ì§‘ ì„ íƒ

## ğŸ”® í–¥í›„ ê°œì„  ì‚¬í•­

### ë‹¨ê¸° (1ì£¼ì¼ ë‚´)
- [ ] ê¸°ì¡´ ì²­êµ¬ì„œë“¤ì˜ due_date ì¼ê´„ ì—…ë°ì´íŠ¸ SQL ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
- [ ] ë‚©ë¶€ê¸°í•œ ê²½ê³¼ ì‹œ ìë™ ì—°ì²´ ì²˜ë¦¬ (Cron Job)
- [ ] ì²­êµ¬ê¸°ê°„/ë‚©ë¶€ê¸°í•œ ê²€ì¦ ë¡œì§ ê°•í™” (ì‹œì‘ì¼ < ì¢…ë£Œì¼ < ë‚©ë¶€ê¸°í•œ)

### ì¤‘ê¸° (1ê°œì›” ë‚´)
- [ ] ì²­êµ¬ì„œ ëª©ë¡ í˜ì´ì§€ì— ì²­êµ¬ê¸°ê°„/ë‚©ë¶€ê¸°í•œ í‘œì‹œ
- [ ] ë‚©ë¶€ê¸°í•œ ì„ë°• ì•Œë¦¼ ê¸°ëŠ¥ (D-3, D-1)
- [ ] ì²­êµ¬ê¸°ê°„ë³„ í†µê³„ ì°¨íŠ¸ ì¶”ê°€

### ì¥ê¸° (3ê°œì›” ë‚´)
- [ ] ì²­êµ¬ê¸°ê°„ í…œí”Œë¦¿ ê¸°ëŠ¥ (ë§¤ì›” ë™ì¼ íŒ¨í„´ ìë™ ì ìš©)
- [ ] ë‚©ë¶€ê¸°í•œ ì—°ì¥ ì‹ ì²­ ê¸°ëŠ¥ (ì‚¬ìš©ì ìš”ì²­ â†’ ê´€ë¦¬ì ìŠ¹ì¸)
- [ ] ì²­êµ¬ê¸°ê°„/ë‚©ë¶€ê¸°í•œ ì´ë ¥ ê´€ë¦¬ (ë³€ê²½ ë¡œê·¸)

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

- [Worklog 001: ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](./001_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md)
- [Worklog 015: ë‚©ë¶€ì•ˆë‚´ ìˆœì„œê´€ë¦¬ ê¸°ëŠ¥ ì¶”ê°€](./015_ë‚©ë¶€ì•ˆë‚´_ìˆœì„œê´€ë¦¬_ê¸°ëŠ¥_ì¶”ê°€.md)
- [PRD: ì „ê¸°ë£Œ ë¶„ë°° ì‹œìŠ¤í…œ](../ì „ê¸°ë£Œ_ë¶„ë°°_ì‹œìŠ¤í…œ.prd)

## ğŸ·ï¸ íƒœê·¸

`#billing-period` `#due-date` `#auto-calculation` `#admin-ui` `#bug-fix` `#date-handling` `#mysql`

---

**ì»¤ë°‹ í•´ì‹œ**: be376e9efff108e23c87d139463d0bbc3e97dd90
**PR**: N/A (ì§ì ‘ main ë¸Œëœì¹˜ ì»¤ë°‹)
**ê²€í† ì**: -
**ìŠ¹ì¸ì**: -
