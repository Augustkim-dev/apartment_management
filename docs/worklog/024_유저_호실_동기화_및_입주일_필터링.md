# 024. 유저-호실 동기화 및 입주일 기준 청구서 필터링

## 작업 일자
2024-12-17

## 작업 개요
1. 유저 관리와 호실(units) 테이블 간의 데이터 동기화 기능 구현
2. 유저 로그인 시 입주일(move_in_date) 기준으로 청구서 데이터 필터링

---

## 1. 유저-호실 테이블 동기화

### 배경
유저 정보 변경 시 호실(units) 테이블의 입주자 정보가 동기화되지 않아 데이터 불일치 발생

### 요구사항
- 유저 삭제 시 해당 호실을 공실로 변경
- 유저 상태가 active → inactive 변경 시 호실을 공실로 변경
- 활성 유저 삭제 시 경고 메시지 표시
- 신규 유저 생성 시 호실 정보 동기화

### 수정 파일

#### 1.1 유저 삭제 API (app/api/users/[id]/route.ts)

**변경 내용**: DELETE 요청 시 unit_id를 조회하여 호실 정보 초기화

```typescript
// DELETE 함수 수정
const users = await query(
  "SELECT role, unit_id FROM users WHERE id = ?",
  [userId]
);

const unitId = users[0].unit_id;

// 유저 삭제
await execute("DELETE FROM users WHERE id = ?", [userId]);

// 호실이 배정되어 있었다면 공실로 변경
if (unitId) {
  await execute(
    "UPDATE units SET tenant_name = NULL, contact = NULL, status = 'vacant' WHERE id = ?",
    [unitId]
  );
}
```

#### 1.2 유저 수정 API (app/api/users/[id]/route.ts)

**변경 내용**: PUT 요청 시 상태 변경 감지하여 호실 동기화

```typescript
// 이전 상태 조회
const oldStatus = currentUser[0]?.status;

// 케이스 2: 상태가 active에서 inactive로 변경된 경우 - 공실 처리
else if (oldStatus === 'active' && status === 'inactive' && oldUnitId) {
  await execute(
    "UPDATE units SET tenant_name = NULL, contact = NULL, status = 'vacant' WHERE id = ?",
    [oldUnitId]
  );
}
```

#### 1.3 유저 생성 API (app/api/users/route.ts)

**변경 내용**: POST 요청 시 호실 배정된 경우 units 테이블 동기화

```typescript
// 호실이 배정된 경우 units 테이블 동기화
if (unit_id) {
  await execute(
    "UPDATE units SET tenant_name = ?, contact = ?, status = 'occupied' WHERE id = ?",
    [full_name, phone || null, unit_id]
  );
}
```

#### 1.4 유저 관리 페이지 (app/dashboard/users/page.tsx)

**변경 내용**: 활성 유저 삭제 시 경고 메시지 표시

```typescript
const handleDelete = async (userId: number, username: string, userStatus: string, unitNumber: string | null) => {
  let confirmMessage = `${username} 사용자를 삭제하시겠습니까?`;

  // active 상태이고 호실이 배정된 경우 경고 메시지 추가
  if (userStatus === 'active' && unitNumber) {
    confirmMessage = `삭제하게 되면 ${unitNumber}호실의 입주정보는 리셋됩니다.\n\n${username} 사용자를 삭제하시겠습니까?`;
  }

  if (!confirm(confirmMessage)) {
    return;
  }
  // ... 삭제 로직
};
```

---

## 2. 입주일 기준 청구서 필터링

### 배경
이전 입주자의 청구서 데이터가 현재 입주자에게 표시되는 문제
- 예: 2024년 3월에 입주한 유저에게 2024년 1~2월 청구서가 표시됨

### 요구사항
- 유저 로그인 시 입주일 이후의 청구서만 표시
- 미납/완납 합계도 입주일 이후 데이터만 포함
- 청구서 상세 페이지의 미납 내역도 입주일 기준 필터링

### 필터링 로직

```sql
-- 입주일이 2024년 3월인 경우
AND (mb.bill_year > 2024 OR (mb.bill_year = 2024 AND mb.bill_month >= 3))
```

### 수정 파일

#### 2.1 유저 대시보드 (app/my/page.tsx)

**변경 내용**: 최근 청구서 목록 및 미납 통계 필터링

```typescript
// 입주일 기준 필터링 조건 설정
const moveInDate = session.user.moveInDate ? new Date(session.user.moveInDate) : null;
const moveInYear = moveInDate?.getFullYear();
const moveInMonth = moveInDate ? moveInDate.getMonth() + 1 : null;

// 입주일 필터 조건 생성
let dateFilter = '';
let billParams: any[] = [session.user.unitId];
let unpaidParams: any[] = [session.user.unitId];

if (moveInYear && moveInMonth) {
  dateFilter = 'AND (mb.bill_year > ? OR (mb.bill_year = ? AND mb.bill_month >= ?))';
  billParams = [session.user.unitId, moveInYear, moveInYear, moveInMonth];
  unpaidParams = [session.user.unitId, moveInYear, moveInYear, moveInMonth];
}

// 최근 청구서 조회 쿼리에 dateFilter 적용
const recentBills = await query<UnitBill[]>(`
  SELECT ...
  FROM unit_bills ub
  JOIN monthly_bills mb ON ub.monthly_bill_id = mb.id
  JOIN units u ON ub.unit_id = u.id
  WHERE ub.unit_id = ?
  ${dateFilter}
  ORDER BY mb.bill_year DESC, mb.bill_month DESC
  LIMIT 6
`, billParams);

// 미납 통계 조회에도 동일하게 적용
const unpaidStatsResult = await query<UnpaidStats[]>(`
  SELECT
    COUNT(*) as unpaid_count,
    COALESCE(SUM(ub.total_amount), 0) as unpaid_total
  FROM unit_bills ub
  JOIN monthly_bills mb ON ub.monthly_bill_id = mb.id
  WHERE ub.unit_id = ?
  AND ub.payment_status != 'paid'
  ${dateFilter}
`, unpaidParams);
```

#### 2.2 청구서 목록 API (app/api/my/bills/route.ts)

**변경 내용**: 요약 통계, 페이징 카운트, 청구서 목록 모두 필터링

```typescript
// 입주일 기준 필터링 조건 설정
const moveInDate = session.user.moveInDate ? new Date(session.user.moveInDate) : null;
const moveInYear = moveInDate?.getFullYear();
const moveInMonth = moveInDate ? moveInDate.getMonth() + 1 : null;

let dateFilter = '';
if (moveInYear && moveInMonth) {
  dateFilter = 'AND (mb.bill_year > ? OR (mb.bill_year = ? AND mb.bill_month >= ?))';
}

// 1. 전체 요약 통계 조회 (입주일 이후 청구서만)
const summaryParams = moveInYear
  ? [session.user.unitId, moveInYear, moveInYear, moveInMonth]
  : [session.user.unitId];

// 2. 필터된 결과의 총 개수 조회 (페이징용, 입주일 이후만)
const countParams = moveInYear
  ? [session.user.unitId, moveInYear, moveInYear, moveInMonth]
  : [session.user.unitId];

// 3. 청구서 목록 조회 (페이징 및 필터 적용, 입주일 이후만)
const billsParams = moveInYear
  ? [session.user.unitId, moveInYear, moveInYear, moveInMonth, limit, offset]
  : [session.user.unitId, limit, offset];
```

#### 2.3 청구서 상세 API (app/api/my/bills/[id]/route.ts)

**변경 내용**: 미납 내역 조회 시 입주일 기준 필터링

```typescript
// 3. 미납 내역 조회 (입주일 이후만)
const moveInDate = session.user.moveInDate ? new Date(session.user.moveInDate) : null;
const moveInYear = moveInDate?.getFullYear();
const moveInMonth = moveInDate ? moveInDate.getMonth() + 1 : null;

let dateFilter = '';
let unpaidParams: any[] = [session.user.unitId, unitBillId];

if (moveInYear && moveInMonth) {
  dateFilter = 'AND (mb.bill_year > ? OR (mb.bill_year = ? AND mb.bill_month >= ?))';
  unpaidParams = [session.user.unitId, unitBillId, moveInYear, moveInYear, moveInMonth];
}

const [unpaidRows] = await connection.execute(`
  SELECT
    mb.bill_year,
    mb.bill_month,
    ub.total_amount as unpaid_amount
  FROM unit_bills ub
  JOIN monthly_bills mb ON ub.monthly_bill_id = mb.id
  WHERE ub.unit_id = ?
  AND ub.payment_status != 'paid'
  AND ub.id != ?
  ${dateFilter}
  ORDER BY mb.bill_year DESC, mb.bill_month DESC
`, unpaidParams);
```

---

## 데이터 흐름 예시

### 입주일 2024년 3월 15일인 유저

**변경 전**
```
청구서 목록: 2023-12, 2024-01, 2024-02, 2024-03, 2024-04, ...
미납 합계: 전체 미납분 합산 (이전 입주자 데이터 포함)
```

**변경 후**
```
청구서 목록: 2024-03, 2024-04, ... (2024-03 이후만)
미납 합계: 2024-03월 이후 미납분만 합산
```

---

## 주의사항

1. **입주일이 NULL인 경우**: 필터링 없이 모든 데이터 표시 (기존 동작 유지)
2. **입주 월 포함**: 입주일이 3월 15일이면 3월 청구서는 표시
3. **청구서 직접 접근**: 청구서 상세 조회는 해당 청구서 자체의 접근 권한만 검증 (입주일 이전 청구서 직접 URL 접근 시 404 반환하지 않음)

---

## 테스트 시나리오

1. **유저-호실 동기화 테스트**
   - 유저 삭제 → 해당 호실이 공실로 변경되는지 확인
   - 유저 상태 inactive 변경 → 해당 호실이 공실로 변경되는지 확인
   - 신규 유저 생성 + 호실 배정 → units 테이블에 tenant_name, contact 업데이트 확인

2. **입주일 필터링 테스트**
   - 입주일이 있는 유저 → 입주일 이전 청구서가 목록에 표시되지 않는지 확인
   - 미납 합계가 입주일 이후 청구서만 포함하는지 확인
   - 청구서 상세 페이지의 미납 내역에 입주일 이전 데이터가 포함되지 않는지 확인

3. **입주일이 없는 유저**
   - 기존처럼 모든 청구서가 표시되어야 함

---

## 관련 커밋

- feat: 유저-호실 테이블 동기화 기능 구현
- feat: 입주일 기준 청구서 데이터 필터링 구현
