# Work Log 015: 납부 안내 순서 관리 기능 추가

## Date: 2025-01-18

## Overview
납부 안내 메시지의 display_order 필드를 추가하고, 관리자가 Dashboard Settings에서 안내사항 순서를 변경할 수 있는 UI를 구현

## Background
- **문제점**:
  - 기존에는 `order` 필드가 있었지만 UI에서 순서 변경 불가
  - 관리자가 납부 안내 순서를 조정할 방법이 없음
  - 템플릿 변수 사용법에 대한 문서화 부족
- **목표**:
  - 관리자가 쉽게 납부 안내 순서를 변경할 수 있도록 개선
  - 더 직관적인 순서 관리 인터페이스 제공
- **범위**:
  - Notice 인터페이스 수정
  - Settings 페이지 UI 개선
  - ConfigService 정렬 로직 업데이트

## Tasks Completed

### 1. Notice 인터페이스 수정 ✅

#### 1.1 필드명 변경
- `order` → `display_order`로 변경 (더 명확한 명칭)
- 영향받은 파일:
  - `lib/services/config-service.ts`
  - `app/dashboard/settings/page.tsx`

```typescript
// 변경 전
interface Notice {
  order: number;
  text: string;
  type: 'info' | 'warning' | 'important';
  active: boolean;
}

// 변경 후
interface Notice {
  display_order: number;
  text: string;
  type: 'info' | 'warning' | 'important';
  active: boolean;
}
```

### 2. Dashboard Settings UI 개선 ✅

#### 2.1 순서 변경 기능 추가
```typescript
const moveNoticeUp = (index: number) => {
  if (index === 0) return;
  setNotices(prev => {
    const newNotices = [...prev];
    // Swap display_order values
    const tempOrder = newNotices[index - 1].display_order;
    newNotices[index - 1].display_order = newNotices[index].display_order;
    newNotices[index].display_order = tempOrder;
    // Swap positions in array
    [newNotices[index - 1], newNotices[index]] = [newNotices[index], newNotices[index - 1]];
    return newNotices;
  });
};

const moveNoticeDown = (index: number) => {
  setNotices(prev => {
    if (index === prev.length - 1) return prev;
    const newNotices = [...prev];
    // Swap display_order values
    const tempOrder = newNotices[index + 1].display_order;
    newNotices[index + 1].display_order = newNotices[index].display_order;
    newNotices[index].display_order = tempOrder;
    // Swap positions in array
    [newNotices[index], newNotices[index + 1]] = [newNotices[index + 1], newNotices[index]];
    return newNotices;
  });
};
```

#### 2.2 UI 컴포넌트 추가
- 순서 번호 뱃지 표시
- 위/아래 화살표 버튼 추가
- 아이콘 import 추가: `ChevronUpIcon`, `ChevronDownIcon`

```typescript
{/* 순서 번호 표시 */}
<div className="flex-shrink-0 flex items-center">
  <span className="inline-flex items-center justify-center h-8 w-8 rounded-full bg-gray-100 text-sm font-medium text-gray-700">
    {notice.display_order}
  </span>
</div>

{/* 순서 변경 버튼 */}
<div className="flex flex-col">
  <button
    onClick={() => moveNoticeUp(index)}
    disabled={index === 0}
    className="p-1 text-gray-400 hover:text-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
    title="위로 이동"
  >
    <ChevronUpIcon className="h-4 w-4" />
  </button>
  <button
    onClick={() => moveNoticeDown(index)}
    disabled={index === notices.length - 1}
    className="p-1 text-gray-400 hover:text-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
    title="아래로 이동"
  >
    <ChevronDownIcon className="h-4 w-4" />
  </button>
</div>
```

### 3. 자동 순서 재정렬 ✅

#### 3.1 항목 추가 시
```typescript
const addNotice = () => {
  const maxOrder = notices.length > 0
    ? Math.max(...notices.map(n => n.display_order))
    : 0;
  setNotices(prev => [...prev, {
    display_order: maxOrder + 1,
    text: '',
    type: 'info',
    active: true
  }]);
};
```

#### 3.2 항목 삭제 시
```typescript
const deleteNotice = (index: number) => {
  setNotices(prev => {
    const filtered = prev.filter((_, i) => i !== index);
    // Re-order display_order to be sequential
    return filtered.map((notice, i) => ({
      ...notice,
      display_order: i + 1
    }));
  });
};
```

### 4. ConfigService 정렬 로직 업데이트 ✅

```typescript
// lib/services/config-service.ts
public async getNotices(): Promise<Notice[]> {
  try {
    const noticesJson = await this.get('notices.payment_notices');

    if (!noticesJson || !Array.isArray(noticesJson)) {
      return [];
    }

    // 템플릿 변수 치환
    const processedNotices: Notice[] = [];
    for (const notice of noticesJson) {
      if (notice.active) {
        const processedText = await this.replaceTemplateVariables(notice.text);
        processedNotices.push({
          ...notice,
          text: processedText
        });
      }
    }

    // display_order 순서대로 정렬
    processedNotices.sort((a, b) => a.display_order - b.display_order);

    return processedNotices;
  } catch (error) {
    console.error('Failed to get notices', error);
    return [];
  }
}
```

### 5. 데이터베이스 업데이트 쿼리 ✅

`scripts/update_notices_display_order.sql` 파일 생성:
```sql
UPDATE app_configurations
SET config_value = '[
  {
    "display_order": 1,
    "text": "전기요금은 매월 {납부일}일까지 납부해 주시기 바랍니다.",
    "type": "info",
    "active": true
  },
  {
    "display_order": 2,
    "text": "미납 시 다음달 {연체시작일}일부터 연체료가 부과됩니다.",
    "type": "warning",
    "active": true
  },
  {
    "display_order": 3,
    "text": "자동이체 신청은 관리사무소로 문의해 주세요.",
    "type": "info",
    "active": true
  },
  {
    "display_order": 4,
    "text": "요금 문의: 관리사무소 ({관리사무소})",
    "type": "info",
    "active": true
  },
  {
    "display_order": 5,
    "text": "계량기 검침일: 매월 {검침시작}일~{검침종료}일",
    "type": "info",
    "active": true
  }
]',
updated_at = CURRENT_TIMESTAMP
WHERE config_key = 'notices.payment_notices';
```

## Template Variables Documentation

### 사용 가능한 템플릿 변수
Settings 페이지에 표시되는 템플릿 변수:
- `{관리사무소}` - 관리사무소 전화번호
- `{납부일}` - 매월 납부 기한일
- `{연체시작일}` - 연체료 부과 시작일
- `{검침시작}` - 검침 시작일
- `{검침종료}` - 검침 종료일
- `{건물명}` - 건물 이름

ConfigService에서 추가로 사용 가능한 템플릿 변수:
- `{계좌번호}` - 납부 계좌번호
- `{은행명}` - 납부 은행명
- `{예금주}` - 계좌 예금주명

### 템플릿 변수 처리 과정
1. 관리자가 Settings에서 기본 정보 설정
2. 납부 안내에 템플릿 변수 포함하여 작성
3. ConfigService의 `replaceTemplateVariables()` 메서드가 자동 치환
4. 사용자에게 실제 값으로 표시

## Technical Implementation

### 파일 구조 변경
```
app/dashboard/settings/page.tsx
├── Notice interface (order → display_order)
├── moveNoticeUp() function (새로 추가)
├── moveNoticeDown() function (새로 추가)
├── addNotice() (display_order 로직 수정)
├── deleteNotice() (순서 재정렬 로직 추가)
└── UI 컴포넌트
    ├── 순서 번호 뱃지
    └── 위/아래 화살표 버튼

lib/services/config-service.ts
├── Notice interface (order → display_order)
└── getNotices() (정렬 로직 수정)

scripts/update_notices_display_order.sql
└── 데이터베이스 업데이트 쿼리
```

### 주요 변경 사항
- **인터페이스 변경**: 2개 파일에서 Notice 인터페이스 수정
- **새로운 함수**: moveNoticeUp, moveNoticeDown 추가
- **UI 컴포넌트**: 순서 번호 뱃지, 화살표 버튼 추가
- **아이콘 추가**: ChevronUpIcon, ChevronDownIcon import

## Performance Improvements

### 1. 순서 변경 효율성
- 인접한 항목끼리만 교체하여 O(1) 복잡도
- 불필요한 전체 배열 재정렬 방지

### 2. 사용자 경험 개선
- 즉각적인 시각적 피드백
- 첫 번째/마지막 항목에서 버튼 비활성화
- 순서 번호로 현재 위치 명확히 표시

## Testing & Validation

### 1. 기능 테스트
- 위/아래 이동: ✅ 정상 동작
- 항목 추가: ✅ 최대 display_order + 1로 추가
- 항목 삭제: ✅ 순서 자동 재정렬
- 저장 및 불러오기: ✅ display_order 유지

### 2. UI 테스트
- 순서 번호 표시: ✅
- 화살표 버튼 활성/비활성: ✅
- 반응형 레이아웃: ✅

### 3. 데이터 일관성
- 데이터베이스 업데이트: ✅ SQL 스크립트 준비
- ConfigService 정렬: ✅ display_order 기준 정렬
- API 응답: ✅ 정렬된 순서로 반환

## Issues & Solutions

### 1. 순서 변경 시 display_order 관리
- **문제**: 항목 위치만 변경하면 display_order가 일치하지 않음
- **해결**: 위치와 display_order 모두 동시에 교체

### 2. 삭제 시 순서 공백
- **문제**: 중간 항목 삭제 시 display_order에 공백 발생
- **해결**: 삭제 후 자동으로 1부터 순차적으로 재정렬

### 3. 첫/마지막 항목 이동 제한
- **문제**: 범위를 벗어난 이동 시도
- **해결**: disabled 속성으로 버튼 비활성화

## Related Files

### Modified
- `app/dashboard/settings/page.tsx` - UI 및 순서 관리 기능 추가
- `lib/services/config-service.ts` - display_order 정렬 로직
- `scripts/update_notices_display_order.sql` - 데이터베이스 마이그레이션

### Previous Work
- Work Log 013: 환경설정 관리 시스템 구현
- Work Log 014: 설정페이지 UI 재설계

## Impact

### 사용자 경험 개선
- ✅ 관리자가 납부 안내 순서를 자유롭게 변경 가능
- ✅ 직관적인 위/아래 화살표 인터페이스
- ✅ 순서 번호로 현재 위치 명확히 표시
- ✅ 즉각적인 시각적 피드백

### 시스템 개선
- ✅ 일관된 display_order 관리
- ✅ 자동 순서 재정렬 기능
- ✅ 데이터 일관성 보장

## Next Steps

### Immediate
- [x] Notice 인터페이스 수정
- [x] 순서 변경 UI 구현
- [x] ConfigService 정렬 로직 수정
- [x] 데이터베이스 업데이트 쿼리 작성

### Future Enhancements
- [ ] 드래그 앤 드롭 순서 변경 기능
- [ ] 순서 변경 히스토리 추적
- [ ] 템플릿 변수 자동완성 기능
- [ ] 미리보기 기능 (템플릿 변수 치환 후)
- [ ] 납부 안내 카테고리 분류 기능

## Summary

납부 안내 메시지의 순서 관리 기능을 성공적으로 구현했습니다. `order` 필드를 `display_order`로 명확하게 변경하고, 관리자가 Settings 페이지에서 쉽게 순서를 조정할 수 있는 UI를 추가했습니다. 위/아래 화살표 버튼으로 직관적인 순서 변경이 가능하며, 항목 추가/삭제 시 자동으로 순서가 재정렬됩니다.

### 주요 성과
- 🔄 직관적인 순서 변경 인터페이스
- 📊 자동 순서 재정렬 시스템
- 🎯 명확한 순서 표시 (번호 뱃지)
- 📝 데이터베이스 마이그레이션 준비
- 🛠️ 일관된 display_order 관리

---

**작성일**: 2025-01-18
**작성자**: Claude Code Assistant
**검토**: Payment Notice Order Management Complete