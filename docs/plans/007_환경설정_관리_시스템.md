# 007. 환경설정 관리 시스템 설계

## 작성일: 2025-09-18

## 1. 개요

### 1.1 배경
현재 시스템에 하드코딩되어 있는 다양한 설정값들(은행 계좌, 연락처, 요금 정보, 안내 문구 등)을 데이터베이스로 이전하여 관리자가 UI를 통해 쉽게 수정할 수 있도록 개선

### 1.2 목표
- 모든 하드코딩된 값을 DB로 이전
- 관리자 설정 페이지 구현
- 동적 설정 로딩 시스템 구축
- 가능한 단일 테이블로 통합 관리

## 2. 데이터베이스 설계

### 2.1 메인 설정 테이블 (app_configurations)

```sql
CREATE TABLE app_configurations (
  id INT PRIMARY KEY AUTO_INCREMENT,
  config_key VARCHAR(100) UNIQUE NOT NULL COMMENT '설정 키 (예: payment.bank_name)',
  config_value TEXT COMMENT '설정 값',
  config_type ENUM('string', 'number', 'boolean', 'json', 'array') DEFAULT 'string' COMMENT '데이터 타입',
  category VARCHAR(50) NOT NULL COMMENT '카테고리 (payment, contact, billing, building, notices, contract)',
  subcategory VARCHAR(50) COMMENT '서브 카테고리',
  display_order INT DEFAULT 0 COMMENT '표시 순서',
  is_active BOOLEAN DEFAULT true COMMENT '활성화 여부',
  is_required BOOLEAN DEFAULT false COMMENT '필수 여부',
  description TEXT COMMENT '설정 설명',
  validation_rules JSON COMMENT '검증 규칙 {"min": 0, "max": 100, "pattern": "^[0-9]+$"}',
  metadata JSON COMMENT '추가 메타데이터',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  updated_by INT COMMENT '마지막 수정자',
  FOREIGN KEY (updated_by) REFERENCES users(id),
  INDEX idx_category (category),
  INDEX idx_active_category (is_active, category)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='시스템 설정 테이블';
```

## 3. 설정 카테고리 및 매핑

### 3.1 결제 정보 (payment)
| 키 | 현재 하드코딩 값 | 설명 |
|---|---|---|
| payment.bank_name | 신한은행 | 주 계좌 은행명 |
| payment.account_number | 100-035-727568 | 주 계좌번호 |
| payment.account_holder | ㈜코로코 | 주 계좌 예금주 |
| payment.bank_name_alt | 국민은행 | 대체 계좌 은행명 |
| payment.account_number_alt | 123-45-678900 | 대체 계좌번호 |
| payment.account_holder_alt | 아르노빌리지 관리사무소 | 대체 계좌 예금주 |

### 3.2 연락처 정보 (contact)
| 키 | 현재 하드코딩 값 | 설명 |
|---|---|---|
| contact.management_phone | 02-1234-5678 | 관리사무소 전화번호 |
| contact.management_email | management@arnodvillage.com | 관리사무소 이메일 |
| contact.emergency_phone | 010-1234-5678 | 비상 연락처 |

### 3.3 건물 정보 (building)
| 키 | 현재 하드코딩 값 | 설명 |
|---|---|---|
| building.name | 아르노빌리지 | 건물명 |
| building.type | 오피스텔 | 건물 유형 |
| building.unit_count | 60 | 총 호실 수 |
| building.total_usage_default | 25231 | 기본 총 사용량(kWh) |

### 3.4 계약 정보 (contract)
| 키 | 현재 하드코딩 값 | 설명 |
|---|---|---|
| contract.type | 일반용(을)고압A선택2 | 계약 종별 |
| contract.power | 700 | 계약 전력(kW) |
| contract.applied_power | 210 | 요금적용 전력(kW) |

### 3.5 요금 정보 (billing)
| 키 | 현재 하드코딩 값 | 설명 |
|---|---|---|
| billing.basic_fee_rate | 8320 | kW당 기본료 |
| billing.late_fee_rate | 1.5 | 연체료율(%) |
| billing.meter_reading_start | 9 | 검침 시작일 |
| billing.meter_reading_end | 10 | 검침 종료일 |
| billing.payment_due_day | 31 | 납부 기한일 |
| billing.late_fee_start_day | 5 | 연체료 부과 시작일 |

### 3.6 납부 안내 (notices)
| 키 | 타입 | 설명 |
|---|---|---|
| notices.payment_notices | JSON 배열 | 납부 안내 문구 목록 |

JSON 구조:
```json
[
  {
    "order": 1,
    "text": "전기요금은 매월 말일까지 납부해 주시기 바랍니다.",
    "type": "info",
    "active": true
  },
  {
    "order": 2,
    "text": "미납 시 다음달 5일부터 연체료가 부과됩니다.",
    "type": "warning",
    "active": true
  }
]
```

## 4. 구현 아키텍처

### 4.1 설정 서비스 (ConfigService)

```typescript
// lib/services/config-service.ts
class ConfigService {
  // 핵심 메서드
  - get(key: string): Promise<any>
  - getByCategory(category: string): Promise<object>
  - set(key: string, value: any): Promise<void>
  - getNotices(): Promise<Notice[]>
  - clearCache(): void

  // 특징
  - 메모리 캐싱 지원
  - 타입 자동 변환
  - 템플릿 변수 치환
  - 트랜잭션 지원
}
```

### 4.2 템플릿 변수 시스템

납부 안내 문구에서 다른 설정값 참조:
- `{관리사무소}` → contact.management_phone
- `{납부일}` → billing.payment_due_day
- `{연체시작일}` → billing.late_fee_start_day
- `{검침시작}` → billing.meter_reading_start
- `{검침종료}` → billing.meter_reading_end

예시:
```
입력: "요금 문의: 관리사무소 ({관리사무소})"
출력: "요금 문의: 관리사무소 (02-1234-5678)"
```

## 5. 관리자 UI 설계

### 5.1 페이지 구조

```
/dashboard/settings
├── 기본 정보 탭 (building, contact)
├── 결제 정보 탭 (payment)
├── 요금 설정 탭 (billing, contract)
└── 납부 안내 탭 (notices)
```

### 5.2 주요 기능

#### 납부 안내 관리
- 드래그 앤 드롭으로 순서 변경
- 안내 유형 선택 (info, warning, important)
- 활성화/비활성화 토글
- 템플릿 변수 자동 완성
- 실시간 미리보기

#### 결제 정보 관리
- 주 계좌/대체 계좌 설정
- 계좌번호 형식 검증
- 복사 버튼 제공

#### 요금 설정 관리
- 숫자 입력 검증
- 단위 표시 (원, kW, % 등)
- 범위 제한 설정

## 6. API 엔드포인트

### 6.1 관리자 API

| 엔드포인트 | 메서드 | 설명 |
|---|---|---|
| /api/admin/settings | GET | 전체 또는 카테고리별 설정 조회 |
| /api/admin/settings | PUT | 설정 일괄 업데이트 |
| /api/admin/settings/notices | GET | 납부 안내 목록 조회 |
| /api/admin/settings/notices | POST | 납부 안내 추가 |
| /api/admin/settings/notices | PUT | 납부 안내 수정 |
| /api/admin/settings/notices | DELETE | 납부 안내 삭제 |
| /api/admin/settings/export | GET | 설정 내보내기 (JSON) |
| /api/admin/settings/import | POST | 설정 가져오기 (JSON) |

### 6.2 사용자 API 업데이트

기존 하드코딩된 값들을 ConfigService를 통해 조회:

```typescript
// Before (하드코딩)
const notices = [
  '전기요금은 매월 말일까지 납부해 주시기 바랍니다.',
  '미납 시 다음달 5일부터 연체료가 부과됩니다.'
];

// After (DB 조회)
const notices = await ConfigService.getNotices();
const paymentInfo = await ConfigService.getByCategory('payment');
```

## 7. 마이그레이션 계획

### 7.1 초기 데이터 입력

```sql
-- 초기 데이터 마이그레이션 스크립트
INSERT INTO app_configurations (config_key, config_value, config_type, category, is_required, description) VALUES
-- 건물 정보
('building.name', '아르노빌리지', 'string', 'building', true, '건물명'),
('building.type', '오피스텔', 'string', 'building', true, '건물 유형'),
('building.unit_count', '60', 'number', 'building', true, '총 호실 수'),

-- 결제 정보
('payment.bank_name', '신한은행', 'string', 'payment', true, '주 계좌 은행명'),
('payment.account_number', '100-035-727568', 'string', 'payment', true, '주 계좌번호'),
('payment.account_holder', '㈜코로코', 'string', 'payment', true, '주 계좌 예금주'),

-- 연락처 정보
('contact.management_phone', '02-1234-5678', 'string', 'contact', true, '관리사무소 전화번호'),

-- 계약 정보
('contract.type', '일반용(을)고압A선택2', 'string', 'contract', true, '계약 종별'),
('contract.power', '700', 'number', 'contract', true, '계약 전력(kW)'),

-- 요금 정보
('billing.basic_fee_rate', '8320', 'number', 'billing', true, 'kW당 기본료'),
('billing.payment_due_day', '31', 'number', 'billing', true, '납부 기한일'),

-- 납부 안내 (JSON)
('notices.payment_notices', '[{"order":1,"text":"전기요금은 매월 말일까지 납부해 주시기 바랍니다.","type":"info","active":true}]', 'json', 'notices', false, '납부 안내 문구');
```

### 7.2 하드코딩 제거 대상 파일

| 파일 경로 | 수정 내용 |
|---|---|
| app/api/my/bills/[id]/route.ts | notices, paymentInfo 하드코딩 제거 |
| app/api/bills/[id]/units/[unitId]/route.ts | 계좌 정보 하드코딩 제거 |
| app/dashboard/bills/[id]/units/[unitId]/page.tsx | 계좌 정보 하드코딩 제거 |
| app/dashboard/bills/[id]/units/[unitId]/print/page.tsx | 계좌 정보 하드코딩 제거 |
| lib/calculation/bill-calculator.ts | 기본 사용량 하드코딩 제거 |

## 8. 구현 일정

### Phase 1: 데이터베이스 (Day 1)
- [ ] app_configurations 테이블 생성
- [ ] 초기 데이터 마이그레이션 스크립트 작성
- [ ] 테이블 인덱스 및 제약조건 설정

### Phase 2: 백엔드 서비스 (Day 2)
- [ ] ConfigService 클래스 구현
- [ ] 캐싱 메커니즘 구현
- [ ] 템플릿 변수 치환 로직 구현

### Phase 3: 관리자 API (Day 3)
- [ ] 설정 CRUD API 구현
- [ ] 납부 안내 전용 API 구현
- [ ] 설정 내보내기/가져오기 API 구현

### Phase 4: 관리자 UI (Day 4-5)
- [ ] 설정 페이지 레이아웃 구현
- [ ] 각 탭별 컴포넌트 개발
- [ ] 납부 안내 드래그 앤 드롭 구현
- [ ] 미리보기 기능 구현

### Phase 5: 사용자 API 업데이트 (Day 6)
- [ ] 하드코딩된 값 제거
- [ ] ConfigService 연동
- [ ] 테스트 및 검증

### Phase 6: 배포 및 마이그레이션 (Day 7)
- [ ] 프로덕션 DB 마이그레이션
- [ ] 성능 테스트
- [ ] 롤백 계획 수립

## 9. 성능 최적화

### 9.1 캐싱 전략
- 메모리 캐시 사용 (Map 객체)
- 설정 변경 시 캐시 무효화
- 카테고리별 캐싱
- TTL: 5분 (조정 가능)

### 9.2 쿼리 최적화
- 인덱스 활용
- 카테고리별 일괄 조회
- 활성 설정만 조회

## 10. 보안 고려사항

### 10.1 권한 관리
- 관리자만 설정 변경 가능
- 감사 로그 기록 (updated_by 필드)
- 민감 정보 암호화 고려

### 10.2 입력 검증
- 설정 타입별 검증 규칙
- SQL 인젝션 방지
- XSS 방지

## 11. 장점

1. **유지보수성**: 코드 수정 없이 설정 변경 가능
2. **유연성**: JSON 타입으로 복잡한 구조 저장
3. **확장성**: 새 설정 추가가 용이
4. **일관성**: 단일 테이블로 통합 관리
5. **추적성**: 변경 이력 관리 가능
6. **성능**: 캐싱으로 빠른 응답

## 12. 위험 요소 및 대응

| 위험 요소 | 대응 방안 |
|---|---|
| 캐시 불일치 | 설정 변경 시 즉시 캐시 무효화 |
| 잘못된 설정값 입력 | 검증 규칙 적용 및 기본값 설정 |
| DB 연결 실패 | 환경 변수 폴백 메커니즘 |
| 마이그레이션 실패 | 트랜잭션 사용 및 롤백 계획 |

## 13. 테스트 계획

### 13.1 단위 테스트
- ConfigService 메서드별 테스트
- 템플릿 변수 치환 테스트
- 타입 변환 테스트

### 13.2 통합 테스트
- API 엔드포인트 테스트
- 관리자 UI 기능 테스트
- 사용자 API 연동 테스트

### 13.3 성능 테스트
- 캐시 적중률 측정
- API 응답 시간 측정
- 동시 요청 처리 테스트

## 14. 참고 사항

- 이 설계는 하드코딩된 값들을 점진적으로 DB로 이전하는 것을 목표로 함
- 환경 변수는 DB 연결 정보 등 인프라 설정에만 사용
- 비즈니스 로직 관련 설정은 모두 DB에서 관리
- 추후 다국어 지원 시 텍스트 관리 시스템과 통합 가능