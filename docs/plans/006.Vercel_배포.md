# Phase 6: Vercel 배포

## 개요
완성된 아르노빌리지 전기료 관리 시스템을 Vercel에 배포하여 실제 운영 환경을 구축합니다. 자체 MySQL 서버와 연동하여 완전 무료로 운영 가능한 환경을 설정합니다.

## 목표
- Vercel 프로젝트 설정 및 GitHub 연동
- 환경 변수 구성
- 자체 MySQL 서버 외부 접속 설정
- 프로덕션 빌드 최적화
- 도메인 설정 및 SSL 적용

## 작업 내용

### 1. 프로젝트 준비

#### 1.1 프로젝트 구조 확인
```
coloco-apartment-management/
├── app/
│   ├── api/
│   │   ├── auth/
│   │   ├── bills/
│   │   ├── calculate/
│   │   ├── dashboard/
│   │   ├── parse/
│   │   └── units/
│   ├── dashboard/
│   │   ├── bills/
│   │   ├── stats/
│   │   ├── units/
│   │   ├── upload/
│   │   └── layout.tsx
│   ├── login/
│   ├── layout.tsx
│   └── page.tsx
├── components/
├── lib/
│   ├── auth/
│   ├── calculation/
│   ├── parsers/
│   ├── services/
│   └── db.ts
├── public/
├── types/
├── .env.local
├── .gitignore
├── middleware.ts
├── next.config.js
├── package.json
├── tailwind.config.js
└── tsconfig.json
```

#### 1.2 package.json 스크립트 확인
```json
{
  "name": "coloco-apartment-management",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "type-check": "tsc --noEmit"
  },
  "dependencies": {
    "next": "14.1.0",
    "react": "^18",
    "react-dom": "^18",
    "mysql2": "^3.7.0",
    "pdf-parse": "^1.1.1",
    "xlsx": "^0.18.5",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "iron-session": "^8.0.1",
    "@headlessui/react": "^1.7.17",
    "@heroicons/react": "^2.1.1",
    "recharts": "^2.10.3",
    "date-fns": "^3.0.6",
    "react-hot-toast": "^2.4.1",
    "react-hook-form": "^7.48.2"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "@types/bcryptjs": "^2.4.6",
    "@types/jsonwebtoken": "^9.0.5",
    "autoprefixer": "^10.0.1",
    "postcss": "^8",
    "tailwindcss": "^3.3.0",
    "typescript": "^5"
  }
}
```

### 2. MySQL 서버 외부 접속 설정

#### 2.1 MySQL 서버 설정
```sql
-- 외부 접속용 사용자 생성
CREATE USER 'coloco_app'@'%' IDENTIFIED BY 'strong_password_here';

-- 권한 부여
GRANT SELECT, INSERT, UPDATE, DELETE ON coloco_apartment.* TO 'coloco_app'@'%';
FLUSH PRIVILEGES;

-- 바인드 주소 확인 (my.cnf 또는 my.ini)
-- bind-address = 0.0.0.0 으로 변경
```

#### 2.2 방화벽 설정
```bash
# Linux 서버의 경우
sudo ufw allow 3306/tcp

# 또는 특정 IP만 허용 (Vercel IP 범위)
sudo ufw allow from 76.76.21.0/24 to any port 3306
```

#### 2.3 SSL 설정 (권장)
```sql
-- SSL 인증서 생성 및 설정
-- MySQL 서버에서 SSL 활성화
SHOW VARIABLES LIKE '%ssl%';

-- 사용자에 SSL 요구
ALTER USER 'coloco_app'@'%' REQUIRE SSL;
```

### 3. 환경 변수 설정

#### 3.1 .env.production 파일 생성
```env
# 프로덕션 환경 변수 (로컬 테스트용)
NODE_ENV=production

# MySQL 연결 정보
MYSQL_HOST=your-mysql-server-public-ip
MYSQL_PORT=3306
MYSQL_USER=coloco_app
MYSQL_PASSWORD=strong_password_here
MYSQL_DATABASE=coloco_apartment
MYSQL_SSL=true

# 연결 풀 설정
MYSQL_CONNECTION_LIMIT=5
MYSQL_QUEUE_LIMIT=0
MYSQL_CONNECT_TIMEOUT=60000

# JWT 설정
JWT_SECRET=your-production-jwt-secret-minimum-32-characters
JWT_EXPIRES_IN=24h

# Session 설정
SESSION_PASSWORD=your-production-session-password-minimum-32-characters

# 기타 설정
NEXT_PUBLIC_APP_URL=https://your-domain.vercel.app
```

#### 3.2 .gitignore 확인
```gitignore
# 환경 변수
.env
.env.local
.env.production
.env.production.local

# 의존성
node_modules/

# Next.js
.next/
out/
build/

# 프로덕션
dist/

# 기타
.DS_Store
*.pem
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# IDE
.vscode/
.idea/
```

### 4. 프로덕션 최적화

#### 4.1 next.config.js 설정
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  swcMinify: true,
  
  // 이미지 최적화
  images: {
    domains: [],
    formats: ['image/avif', 'image/webp'],
  },
  
  // 보안 헤더
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'X-DNS-Prefetch-Control',
            value: 'on'
          },
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=63072000; includeSubDomains; preload'
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY'
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block'
          },
          {
            key: 'Referrer-Policy',
            value: 'origin-when-cross-origin'
          }
        ]
      }
    ]
  },
  
  // 환경 변수
  env: {
    NEXT_PUBLIC_APP_NAME: '아르노빌리지 전기료 관리 시스템',
  },
}

module.exports = nextConfig
```

#### 4.2 데이터베이스 연결 최적화 (`lib/db.ts`)
```typescript
import mysql from 'mysql2/promise';

const config: mysql.PoolOptions = {
  host: process.env.MYSQL_HOST,
  port: parseInt(process.env.MYSQL_PORT || '3306'),
  user: process.env.MYSQL_USER,
  password: process.env.MYSQL_PASSWORD,
  database: process.env.MYSQL_DATABASE,
  waitForConnections: true,
  connectionLimit: parseInt(process.env.MYSQL_CONNECTION_LIMIT || '5'),
  queueLimit: parseInt(process.env.MYSQL_QUEUE_LIMIT || '0'),
  connectTimeout: parseInt(process.env.MYSQL_CONNECT_TIMEOUT || '60000'),
  enableKeepAlive: true,
  keepAliveInitialDelay: 0,
};

// SSL 설정 (프로덕션)
if (process.env.NODE_ENV === 'production' && process.env.MYSQL_SSL === 'true') {
  config.ssl = {
    rejectUnauthorized: true,
  };
}

// 연결 풀 생성
let pool: mysql.Pool;

try {
  pool = mysql.createPool(config);
  
  // 연결 테스트
  if (process.env.NODE_ENV === 'development') {
    pool.getConnection()
      .then(connection => {
        console.log('Database connected successfully');
        connection.release();
      })
      .catch(err => {
        console.error('Database connection failed:', err);
      });
  }
} catch (error) {
  console.error('Failed to create connection pool:', error);
  throw error;
}

export default pool;
```

### 5. GitHub 저장소 설정

#### 5.1 저장소 생성 및 푸시
```bash
# Git 초기화
git init

# 원격 저장소 추가
git remote add origin https://github.com/your-username/coloco-apartment-management.git

# 초기 커밋
git add .
git commit -m "Initial commit: 아르노빌리지 전기료 관리 시스템"

# 메인 브랜치로 푸시
git branch -M main
git push -u origin main
```

#### 5.2 GitHub Actions 워크플로우 (선택사항)
`.github/workflows/ci.yml`:
```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run type check
      run: npm run type-check
    
    - name: Run linter
      run: npm run lint
    
    - name: Build
      run: npm run build
```

### 6. Vercel 배포

#### 6.1 Vercel CLI 설치 (선택사항)
```bash
npm i -g vercel
```

#### 6.2 Vercel 프로젝트 생성
1. [vercel.com](https://vercel.com) 접속 및 로그인
2. "New Project" 클릭
3. GitHub 저장소 Import
4. 프로젝트 설정:
   - Framework Preset: Next.js
   - Root Directory: ./
   - Build Command: `npm run build`
   - Output Directory: `.next`

#### 6.3 환경 변수 설정 (Vercel Dashboard)
```
Settings → Environment Variables에서 추가:

MYSQL_HOST=your-mysql-server-ip
MYSQL_PORT=3306
MYSQL_USER=coloco_app
MYSQL_PASSWORD=[암호화된 비밀번호]
MYSQL_DATABASE=coloco_apartment
MYSQL_SSL=true
MYSQL_CONNECTION_LIMIT=5
MYSQL_QUEUE_LIMIT=0
MYSQL_CONNECT_TIMEOUT=60000

JWT_SECRET=[긴 랜덤 문자열]
JWT_EXPIRES_IN=24h

SESSION_PASSWORD=[긴 랜덤 문자열]

NEXT_PUBLIC_APP_URL=https://coloco-apartment.vercel.app
```

#### 6.4 도메인 설정
1. Vercel Dashboard → Settings → Domains
2. 커스텀 도메인 추가 (선택사항)
3. DNS 설정:
   ```
   Type: CNAME
   Name: app
   Value: cname.vercel-dns.com
   ```

### 7. 배포 확인 및 모니터링

#### 7.1 배포 상태 확인
```bash
# Vercel CLI 사용 시
vercel --prod

# 또는 Git push로 자동 배포
git push origin main
```

#### 7.2 로그 확인
- Vercel Dashboard → Functions → Logs
- 실시간 로그 스트리밍 가능

#### 7.3 성능 모니터링
- Vercel Analytics 활성화
- Web Vitals 모니터링
- 에러 추적 설정

### 8. 배포 후 체크리스트

#### 8.1 기능 테스트
- [ ] 로그인/로그아웃
- [ ] PDF 업로드 및 파싱
- [ ] Excel 업로드 및 파싱
- [ ] 청구서 생성
- [ ] 청구서 조회
- [ ] 대시보드 통계
- [ ] 호실 관리

#### 8.2 성능 테스트
- [ ] 페이지 로딩 속도
- [ ] API 응답 시간
- [ ] 데이터베이스 연결
- [ ] 대용량 파일 처리

#### 8.3 보안 점검
- [ ] HTTPS 적용 확인
- [ ] 환경 변수 보안
- [ ] SQL Injection 방지
- [ ] XSS 방지
- [ ] CSRF 보호

### 9. 트러블슈팅

#### 9.1 MySQL 연결 실패
```javascript
// 연결 디버깅 코드 추가
if (process.env.NODE_ENV === 'production') {
  console.log('Attempting to connect to MySQL:', {
    host: process.env.MYSQL_HOST,
    port: process.env.MYSQL_PORT,
    database: process.env.MYSQL_DATABASE,
    ssl: process.env.MYSQL_SSL
  });
}
```

#### 9.2 Vercel 함수 타임아웃
```javascript
// vercel.json 생성
{
  "functions": {
    "app/api/parse/pdf/route.ts": {
      "maxDuration": 10
    },
    "app/api/calculate/route.ts": {
      "maxDuration": 10
    }
  }
}
```

#### 9.3 CORS 이슈
```javascript
// API 라우트에 CORS 헤더 추가
export async function POST(request: NextRequest) {
  const response = NextResponse.json(data);
  
  // CORS 헤더 설정
  response.headers.set('Access-Control-Allow-Origin', '*');
  response.headers.set('Access-Control-Allow-Methods', 'POST, OPTIONS');
  
  return response;
}
```

### 10. 백업 및 복구 계획

#### 10.1 데이터베이스 백업
```bash
# 일일 백업 스크립트
#!/bin/bash
DATE=$(date +%Y%m%d)
mysqldump -u coloco_app -p coloco_apartment > backup_$DATE.sql
```

#### 10.2 복구 절차
1. Vercel 롤백 기능 사용
2. GitHub 이전 커밋으로 복원
3. 데이터베이스 백업 복원

## 예상 소요 시간
- MySQL 서버 설정: 2시간
- 환경 변수 구성: 1시간
- GitHub 저장소 설정: 1시간
- Vercel 프로젝트 생성: 1시간
- 배포 및 테스트: 2시간
- 도메인 설정: 1시간
- **총 예상 시간: 8시간**

## 운영 관리

### 월간 점검 사항
- [ ] 시스템 로그 검토
- [ ] 데이터베이스 백업 확인
- [ ] 보안 업데이트 적용
- [ ] 사용량 통계 분석
- [ ] 성능 메트릭 검토

### 긴급 대응 연락처
- 시스템 관리자: [연락처]
- 데이터베이스 관리자: [연락처]
- Vercel 지원: support@vercel.com

## 완료
모든 Phase가 완료되었습니다. 시스템이 성공적으로 배포되면 실제 운영을 시작할 수 있습니다.