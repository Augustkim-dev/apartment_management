# 009. 이사 정산 - 중도 퇴거/입주 분할 청구 기능

**작성일**: 2026-02-11
**상태**: 계획 중
**목표**: 월 중간 이사(퇴거/입주) 시 같은 호실에 퇴거자·입주자 각각 별도 청구서를 발행하는 기능 추가

---

## 1. 배경 및 목적

### 배경
- 현재 시스템은 **1호실 = 1청구서/월** 구조 (`UNIQUE KEY (monthly_bill_id, unit_id)`)
- 입주자 정보가 `units.tenant_name` 문자열 하나로만 관리됨 (별도 입주자 엔티티 없음)
- 월 중간에 퇴거/입주가 발생하면 같은 호실에 2건의 청구서가 필요하지만 현재 구조로는 불가능

### 시나리오 예시
```
청구기간: 1월 9일 ~ 2월 9일 (매월 9일 KEPCO 검침 고정)

201호:
  퇴거자 A: 1/9 ~ 1/16 09:00 (사용량 실측 가능)
  입주자 B: 1/16 13:00 ~ 2/9 (KEPCO 청구서 도착 후 정상 계산)

문제: 퇴거 시점에 건물 전체 요금이 확정되지 않음
해결: 직전 3개월 평균 데이터로 추정하여 퇴거자에게 부과
차액: 건물 관리비로 흡수 (퇴거자에게 추가 청구/환불 없음)
```

### 목적
1. 같은 호실에 월 2건 청구서 발행 지원
2. 퇴거자에게 추정 기반 즉시 정산
3. 입주자에게 실제 KEPCO 데이터 기반 정상 정산
4. 입주자 이력 관리 (누가 언제 살았는지 추적)

---

## 2. 데이터베이스 변경

### 2-1. `tenants` 테이블 신규 생성

입주자 이력을 별도로 관리하는 테이블.

```sql
CREATE TABLE tenants (
  id INT PRIMARY KEY AUTO_INCREMENT,
  unit_id INT NOT NULL,
  name VARCHAR(100) NOT NULL,
  contact VARCHAR(20),
  email VARCHAR(100),
  status ENUM('active', 'moved_out') DEFAULT 'active',
  move_in_date DATE NOT NULL,
  move_out_date DATE,
  move_in_reading DECIMAL(10,2),    -- 입주 시 계량기 값
  move_out_reading DECIMAL(10,2),   -- 퇴거 시 계량기 값
  notes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  FOREIGN KEY (unit_id) REFERENCES units(id) ON DELETE CASCADE,
  INDEX idx_unit_id (unit_id),
  INDEX idx_status (status),
  INDEX idx_unit_status (unit_id, status)
);
```

### 2-2. `move_settlements` 테이블 신규 생성

이사 정산 이벤트를 추적하는 테이블.

```sql
CREATE TABLE move_settlements (
  id INT PRIMARY KEY AUTO_INCREMENT,
  unit_id INT NOT NULL,
  settlement_date DATETIME NOT NULL,         -- 정산 일시
  bill_year INT NOT NULL,
  bill_month INT NOT NULL,

  -- 퇴거자 정보
  outgoing_tenant_id INT NOT NULL,
  outgoing_period_start DATE NOT NULL,       -- 퇴거자 청구 시작일
  outgoing_period_end DATETIME NOT NULL,     -- 퇴거 일시
  outgoing_meter_reading DECIMAL(10,2),      -- 퇴거 시 계량기값
  outgoing_usage DECIMAL(10,2),              -- 퇴거자 사용량

  -- 입주자 정보 (나중에 등록 가능)
  incoming_tenant_id INT,
  incoming_period_start DATETIME,            -- 입주 일시
  incoming_meter_reading DECIMAL(10,2),      -- 입주 시 계량기값

  -- 추정 기준 데이터
  estimated_total_usage DECIMAL(10,2),       -- 추정 건물 전체 사용량 (3개월 평균)
  estimated_total_amount DECIMAL(10,2),      -- 추정 건물 전체 요금
  estimation_base_months TEXT,               -- 참조한 월 목록 (JSON)

  status ENUM('pending', 'completed', 'cancelled') DEFAULT 'pending',
  notes TEXT,
  created_by INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  FOREIGN KEY (unit_id) REFERENCES units(id),
  FOREIGN KEY (outgoing_tenant_id) REFERENCES tenants(id),
  FOREIGN KEY (incoming_tenant_id) REFERENCES tenants(id),
  INDEX idx_unit_year_month (unit_id, bill_year, bill_month),
  INDEX idx_status (status)
);
```

### 2-3. `unit_bills` 테이블 변경

```sql
-- 1. 새 컬럼 추가
ALTER TABLE unit_bills
  ADD COLUMN tenant_id INT AFTER unit_id,
  ADD COLUMN tenant_name_snapshot VARCHAR(100) AFTER tenant_id,
  ADD COLUMN bill_type ENUM('regular', 'move_out', 'move_in') DEFAULT 'regular' AFTER tenant_name_snapshot,
  ADD COLUMN move_settlement_id INT AFTER bill_type,
  ADD COLUMN billing_period_start DATE AFTER move_settlement_id,
  ADD COLUMN billing_period_end DATE AFTER billing_period_start,
  ADD COLUMN is_estimated BOOLEAN DEFAULT FALSE AFTER billing_period_end;

-- 2. 기존 UNIQUE KEY 교체 (같은 호실에 2건 허용)
ALTER TABLE unit_bills DROP INDEX unique_unit_bill;
ALTER TABLE unit_bills ADD UNIQUE KEY unique_unit_tenant_bill
  (monthly_bill_id, unit_id, bill_type, tenant_id);

-- 3. FK 추가
ALTER TABLE unit_bills
  ADD FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE SET NULL,
  ADD FOREIGN KEY (move_settlement_id) REFERENCES move_settlements(id) ON DELETE SET NULL;
```

**새 컬럼 설명**:
| 컬럼 | 설명 |
|------|------|
| `tenant_id` | 청구 대상 입주자 (tenants FK) |
| `tenant_name_snapshot` | 청구 시점의 입주자 이름 (이력 보존) |
| `bill_type` | `regular`: 정기, `move_out`: 퇴거정산, `move_in`: 입주정산 |
| `move_settlement_id` | 이사정산 이벤트 참조 (move_settlements FK) |
| `billing_period_start/end` | 이 청구서의 실제 적용 기간 |
| `is_estimated` | 추정 기반 청구 여부 |

### 2-4. 기존 데이터 마이그레이션

```sql
-- 현재 units 데이터에서 tenants 레코드 생성
INSERT INTO tenants (unit_id, name, contact, email, status, move_in_date)
SELECT id, tenant_name, contact, email,
  CASE WHEN status = 'occupied' THEN 'active' ELSE 'moved_out' END,
  COALESCE(move_in_date, '2024-01-01')
FROM units WHERE tenant_name IS NOT NULL;

-- 기존 unit_bills에 tenant_id, bill_type 연결
UPDATE unit_bills ub
JOIN units u ON ub.unit_id = u.id
JOIN tenants t ON t.unit_id = u.id AND t.status = 'active'
SET ub.tenant_id = t.id,
    ub.tenant_name_snapshot = t.name,
    ub.bill_type = 'regular';
```

### 마이그레이션 파일
**파일**: `scripts/migration_009_move_settlement.sql` (신규)
- 위 2-1 ~ 2-4 내용을 하나의 스크립트로 통합

---

## 3. TypeScript 타입 정의

### 3-1. 기존 타입 수정
**파일**: `types/database.ts`

`UnitBill` 인터페이스에 추가:
```typescript
// 이사 정산 관련 (009 추가)
tenantId: number | null;
tenantNameSnapshot: string | null;
billType: 'regular' | 'move_out' | 'move_in';
moveSettlementId: number | null;
billingPeriodStart: Date | null;
billingPeriodEnd: Date | null;
isEstimated: boolean;
```

`Tenant` 인터페이스 신규 추가:
```typescript
export interface Tenant {
  id: number;
  unitId: number;
  name: string;
  contact: string | null;
  email: string | null;
  status: 'active' | 'moved_out';
  moveInDate: Date;
  moveOutDate: Date | null;
  moveInReading: number | null;
  moveOutReading: number | null;
  notes: string | null;
  createdAt: Date;
  updatedAt: Date;
}
```

`MoveSettlement` 인터페이스 신규 추가:
```typescript
export interface MoveSettlement {
  id: number;
  unitId: number;
  settlementDate: Date;
  billYear: number;
  billMonth: number;
  outgoingTenantId: number;
  outgoingPeriodStart: Date;
  outgoingPeriodEnd: Date;
  outgoingMeterReading: number | null;
  outgoingUsage: number | null;
  incomingTenantId: number | null;
  incomingPeriodStart: Date | null;
  incomingMeterReading: number | null;
  estimatedTotalUsage: number | null;
  estimatedTotalAmount: number | null;
  estimationBaseMonths: string | null;
  status: 'pending' | 'completed' | 'cancelled';
  notes: string | null;
  createdBy: number | null;
  createdAt: Date;
  updatedAt: Date;
}
```

### 3-2. 이사 정산 전용 타입
**파일**: `types/move-settlement.ts` (신규)

```typescript
// 추정 계산에 사용할 건물 전체 평균 데이터
export interface EstimatedBuildingCharges {
  avgTotalUsage: number;
  avgBasicFee: number;
  avgPowerFee: number;
  avgClimateFee: number;
  avgFuelFee: number;
  avgPowerFactorFee: number;
  avgVat: number;
  avgPowerFund: number;
  avgTotalAmount: number;
  baseMonths: { year: number; month: number }[];
}

// 이사 정산 생성 요청
export interface MoveOutSettlementRequest {
  unitId: number;
  settlementDate: string;          // ISO datetime
  meterReading: number;            // 퇴거 시 계량기값
  incomingTenant?: {               // 즉시 입주자 등록 (선택)
    name: string;
    contact?: string;
    email?: string;
    moveInDate: string;
    moveInReading: number;
  };
  notes?: string;
}

// 추정 결과
export interface EstimationResult {
  outgoingUsage: number;
  estimatedCharges: EstimatedBuildingCharges;
  calculatedBill: {
    usageRatio: number;
    basicFee: number;
    powerFee: number;
    climateFee: number;
    fuelFee: number;
    powerFactorFee: number;
    vat: number;
    powerFund: number;
    totalAmount: number;
  };
}
```

---

## 4. 추정 계산 엔진

### 4-1. 추정 서비스
**파일**: `lib/services/estimation.service.ts` (신규)

**핵심 로직**:
```
getLast3MonthsData(year, month)
  → monthly_bills에서 해당 월 이전 3개월 데이터 조회
  → 데이터가 3개월 미만이면 있는 만큼 사용 (최소 1개월 필요)

calculateAverage(months)
  → 8개 요금항목 + 전체 사용량의 평균 계산
  → EstimatedBuildingCharges 반환

calculateMoveOutBill(outgoingUsage, estimatedCharges)
  → usageRatio = outgoingUsage / avgTotalUsage
  → 각 요금항목 = avg항목 × usageRatio
  → 10원 단위 반올림
  → EstimationResult 반환
```

**기존 코드 재활용**:
- `unit-bills.service.ts:479-545`의 `recalculateFees()` 비율 계산 패턴과 동일
- 차이점: `monthly_bills` 실제 데이터 대신 3개월 평균 데이터 사용

---

## 5. 이사 정산 서비스

### 5-1. 핵심 서비스
**파일**: `lib/services/move-settlement.service.ts` (신규)

**주요 메서드**:

#### `createMoveOutSettlement(request)`
퇴거 처리 + 추정 청구서 생성의 전체 흐름:
```
1. 현재 active tenant 조회 (unit_id 기준)
2. 청구기간 결정 (매월 9일 기준으로 해당 청구월 계산)
3. 이전 검침값 조회:
   - 직전 unit_bill의 current_reading
   - 또는 tenant의 move_in_reading (첫 달인 경우)
4. 퇴거자 사용량 = 퇴거 시 계량기값 - 이전 검침값
5. EstimationService로 추정 요금 계산
6. 트랜잭션 내에서:
   a. move_settlements 레코드 생성
   b. unit_bills에 bill_type='move_out', is_estimated=true 삽입
   c. tenant status → 'moved_out', move_out_date/reading 업데이트
   d. 입주자 있으면 새 tenant 레코드 생성 (status='active')
   e. units.tenant_name 업데이트
```

#### `registerIncomingTenant(settlementId, tenantInfo)`
나중에 입주자를 등록하는 경우

#### `getSettlements(filters)`
이사 정산 목록 조회 (필터: 호실, 기간, 상태)

#### `getSettlementDetail(id)`
이사 정산 상세 (퇴거자 추정 청구서 + 입주자 정보)

### 5-2. 기존 서비스 수정
**파일**: `lib/services/unit-bills.service.ts`

**`saveCalculationResults()` 수정** (line 15-101):
```
변경 전: DELETE FROM unit_bills WHERE monthly_bill_id = ?
변경 후: DELETE FROM unit_bills WHERE monthly_bill_id = ? AND bill_type = 'regular'

→ 이사정산 청구서(move_out, move_in)는 재계산 시 삭제되지 않도록 보호

INSERT 시 추가 필드:
  - tenant_id (현재 active tenant)
  - tenant_name_snapshot
  - bill_type = 'regular'

이사 정산 호실 특별 처리:
  - 해당 월에 move_settlements가 있는 호실 조회
  - 입주자 사용량 = Excel 전체 사용량 - 퇴거자 사용량
  - bill_type = 'move_in'으로 삽입
```

**`getMonthlyUnitBills()` 수정** (line 106-122):
```
- LEFT JOIN tenants 추가
- bill_type, is_estimated, tenant_name_snapshot 필드 포함
- 같은 호실이 2건 나올 수 있도록 처리
```

---

## 6. API 엔드포인트

### 6-1. 이사 정산 API (신규)

| 파일 | 메서드 | 설명 |
|------|--------|------|
| `app/api/move-settlements/route.ts` | GET | 이사 정산 목록 조회 |
| `app/api/move-settlements/route.ts` | POST | 이사 정산 생성 (퇴거 처리) |
| `app/api/move-settlements/[id]/route.ts` | GET | 이사 정산 상세 조회 |
| `app/api/move-settlements/[id]/route.ts` | PATCH | 입주자 등록, 상태 변경 |
| `app/api/move-settlements/estimate/route.ts` | POST | 추정 금액 미리보기 (저장 없이) |

### 6-2. 입주자 관리 API (신규)

| 파일 | 메서드 | 설명 |
|------|--------|------|
| `app/api/tenants/route.ts` | GET | 입주자 목록/이력 조회 |
| `app/api/tenants/route.ts` | POST | 입주자 등록 |
| `app/api/tenants/[id]/route.ts` | GET | 입주자 상세 |
| `app/api/tenants/[id]/route.ts` | PATCH | 입주자 정보 수정 |

### 6-3. 기존 API 수정

**`app/api/bills/[id]/units/route.ts`**:
- 응답에 `billType`, `tenantNameSnapshot`, `isEstimated` 필드 추가
- 같은 호실이 여러 건(move_out + move_in) 나올 수 있도록 처리

**`app/api/calculate/recalculate/route.ts`**:
- 재계산 시 `bill_type IN ('move_out')` 기존 이사정산 청구서 보호
- 이사 정산 호실은 `bill_type='move_in'`으로 생성

**`app/api/unit-bills/route.ts`**:
- 호실별 이력 조회 시 `bill_type` 필터 지원

---

## 7. UI 변경

### 7-1. 이사 정산 페이지 (신규)

**`app/dashboard/move-settlements/page.tsx`** - 이사 정산 목록
- 호실, 기간, 상태 필터
- 각 항목: 호실, 퇴거자/입주자명, 정산일, 추정금액, 상태 배지

**`app/dashboard/move-settlements/new/page.tsx`** - 이사 정산 생성 (멀티스텝 폼)
```
┌─────────────────────────────────────────────┐
│ Step 1: 호실 선택                             │
│ → 현재 입주자 정보 자동 표시                    │
├─────────────────────────────────────────────┤
│ Step 2: 퇴거 정보 입력                         │
│ → 퇴거 일시, 퇴거 시 계량기값 입력              │
├─────────────────────────────────────────────┤
│ Step 3: 추정 금액 미리보기                      │
│ → 3개월 평균 기반 추정 결과 표시                │
│ → 참조한 월별 데이터 표시                       │
├─────────────────────────────────────────────┤
│ Step 4: 입주자 등록 (선택)                      │
│ → 이름, 연락처, 입주일, 입주 시 계량기값         │
├─────────────────────────────────────────────┤
│ Step 5: 확인 및 저장                           │
│ → 전체 내용 요약 → [정산 실행] 버튼             │
└─────────────────────────────────────────────┘
```

**`app/dashboard/move-settlements/[id]/page.tsx`** - 이사 정산 상세
- 퇴거자 추정 청구서 내역
- 입주자 정보 (등록된 경우)
- 추정 기준 데이터 (3개월 평균)

### 7-2. 기존 UI 수정

**`app/dashboard/bills/[id]/page.tsx`** (청구서 상세 - 호실별 테이블):
- 같은 호실이 2행으로 표시될 수 있도록 수정
- `bill_type` 배지: `정기`, `퇴거정산`, `입주정산`
- `is_estimated` 시 "추정" 라벨 표시
- `tenant_name_snapshot`으로 입주자명 표시

**`app/dashboard/bills/[id]/units/[unitId]/page.tsx`** (고지서):
- 같은 unitId에 2건 있을 수 있으므로 query parameter `?billType=move_out` 추가
- 추정 청구서인 경우 "추정 기반 정산" 안내 문구 표시

**`app/dashboard/units/page.tsx`** (호실 관리):
- 현재 입주자 + 이전 입주자 이력 표시 영역 추가
- "이사 정산" 버튼 → `/dashboard/move-settlements/new?unitId=XX`

**`app/dashboard/layout.tsx`** (또는 사이드바 컴포넌트):
- 네비게이션에 "이사 정산" 메뉴 항목 추가

---

## 8. 월별 정산 시 이사 호실 처리 로직

`saveCalculationResults()` 수정 상세 흐름:

```
월별 정산(재계산) 실행 시:

1. 해당 월에 move_settlements 테이블에서 이사 정산이 있는 호실 목록 조회

2. 일반 호실 (이사 없음):
   → bill_type='regular'로 정상 처리 (기존 로직 동일)

3. 이사 정산 호실:
   a. bill_type='move_out' 청구서는 이미 존재 → 건드리지 않음 (보호)
   b. Excel 데이터에서 해당 호실의 당월 전체 사용량 조회
   c. 입주자 사용량 = 당월 전체 사용량 - 퇴거자 사용량
      (move_settlement.outgoing_usage에서 조회)
   d. bill_type='move_in', tenant_id=incoming_tenant_id로 청구서 생성
   e. billing_period_start = 입주일, billing_period_end = 청구기간 종료일
   f. is_estimated = false (실제 KEPCO 데이터 기반)
```

---

## 9. 수정 대상 파일 요약

### 신규 파일 (10개)

| # | 파일 | 설명 |
|---|------|------|
| 1 | `scripts/migration_009_move_settlement.sql` | DB 마이그레이션 |
| 2 | `types/move-settlement.ts` | 이사 정산 타입 정의 |
| 3 | `lib/services/estimation.service.ts` | 3개월 평균 추정 서비스 |
| 4 | `lib/services/move-settlement.service.ts` | 이사 정산 비즈니스 로직 |
| 5 | `app/api/move-settlements/route.ts` | 이사 정산 목록/생성 API |
| 6 | `app/api/move-settlements/[id]/route.ts` | 이사 정산 상세/수정 API |
| 7 | `app/api/move-settlements/estimate/route.ts` | 추정 금액 미리보기 API |
| 8 | `app/api/tenants/route.ts` | 입주자 관리 API |
| 9 | `app/dashboard/move-settlements/page.tsx` | 이사 정산 목록 페이지 |
| 10 | `app/dashboard/move-settlements/new/page.tsx` | 이사 정산 생성 페이지 |

### 수정 파일 (8개)

| # | 파일 | 변경 내용 |
|---|------|----------|
| 1 | `types/database.ts` | Tenant, MoveSettlement 인터페이스 추가, UnitBill 확장 |
| 2 | `lib/services/unit-bills.service.ts` | saveCalculationResults 이사정산 보호, tenant JOIN |
| 3 | `app/api/bills/[id]/units/route.ts` | 응답에 billType, tenantName 추가 |
| 4 | `app/api/calculate/recalculate/route.ts` | 이사정산 청구서 보호 로직 |
| 5 | `app/dashboard/bills/[id]/page.tsx` | 테이블에 bill_type 배지, 중복 호실 표시 |
| 6 | `app/dashboard/bills/[id]/units/[unitId]/page.tsx` | billType query param 지원 |
| 7 | `app/dashboard/units/page.tsx` | 입주자 이력, 이사정산 버튼 |
| 8 | `app/dashboard/layout.tsx` | 이사 정산 메뉴 추가 |

---

## 10. 구현 순서

| 단계 | 작업 | 의존성 |
|------|------|--------|
| **Step 1** | DB 마이그레이션 + 타입 정의 | 없음 |
| **Step 2** | 추정 계산 엔진 (`estimation.service.ts`) | Step 1 |
| **Step 3** | 이사 정산 서비스 (`move-settlement.service.ts`) | Step 1, 2 |
| **Step 4** | `unit-bills.service.ts` 수정 (이사정산 보호 로직) | Step 1, 3 |
| **Step 5** | API 엔드포인트 (이사정산 + 입주자 관리) | Step 3, 4 |
| **Step 6** | 기존 API 수정 (bills, unit-bills, recalculate) | Step 4 |
| **Step 7** | UI - 이사 정산 페이지 (목록, 생성, 상세) | Step 5 |
| **Step 8** | UI - 기존 페이지 수정 (bills, units, 네비게이션) | Step 6 |

---

## 11. 검증 방법

### 11-1. DB 마이그레이션 검증
- 마이그레이션 스크립트 실행 후 테이블 생성 확인 (`SHOW TABLES`, `DESCRIBE tenants`)
- 기존 데이터 마이그레이션 정합성 확인:
  - `SELECT COUNT(*) FROM tenants` = occupied units 수와 일치
  - `SELECT COUNT(*) FROM unit_bills WHERE tenant_id IS NOT NULL` = 전체 unit_bills 수
  - 기존 unit_bills의 bill_type이 모두 'regular'인지 확인
- 새 UNIQUE KEY 동작 확인: 같은 (monthly_bill_id, unit_id)에 다른 (bill_type, tenant_id) 조합으로 2건 삽입 가능한지 테스트

### 11-2. 추정 엔진 검증
- 실제 3개월 monthly_bills 데이터가 있는 상태에서:
  - `EstimationService.getLast3MonthsData()` 호출 → 3건 반환 확인
  - `calculateAverage()` 결과를 수동 계산(엑셀)과 대조
  - `calculateMoveOutBill()` 결과: 추정 요금의 8개 항목 합계 = totalAmount 확인
- 3개월 미만 데이터 케이스: 1개월만 있을 때도 정상 동작하는지 확인

### 11-3. 관리자 실행 테스트

관리자가 개발 서버에서 직접 다음 시나리오를 순서대로 실행:

**시나리오 A: 이사 정산 기본 흐름**
1. `/dashboard/move-settlements/new` 접속
2. 입주 중인 호실 선택 → 현재 입주자 정보 자동 표시 확인
3. 퇴거 일시, 계량기값 입력 → 추정 금액 미리보기 확인
4. 입주자 정보 입력 (선택) → 정산 실행
5. `/dashboard/move-settlements` 목록에 생성된 정산 확인

**시나리오 B: 청구서 상세에서 분할 표시 확인**
1. 이사 정산 처리된 호실이 포함된 월의 청구서 상세 페이지 확인
2. 해당 호실이 2행(퇴거/입주)으로 표시되는지 확인
3. `퇴거정산`, `입주정산` 배지 표시 확인
4. 퇴거 건에 "추정" 라벨 표시 확인

**시나리오 C: 월별 재계산 시 보호 확인**
1. 이사 정산이 있는 월에 대해 재계산 실행
2. 퇴거자 청구서(move_out)가 삭제되지 않고 유지되는지 확인
3. 입주자 청구서(move_in)가 실제 KEPCO 데이터 기반으로 재생성되는지 확인
4. 일반 호실 청구서는 정상 재계산되는지 확인

**시나리오 D: 호실 관리 페이지**
1. `/dashboard/units`에서 이사 정산 처리된 호실 확인
2. 입주자 이력(이전 입주자, 현재 입주자) 표시 확인
3. "이사 정산" 버튼 동작 확인

---

## 12. 참고 자료

- 기존 계산 엔진: `lib/calculation/bill-calculator.ts`
- 기존 비율 재계산: `lib/services/unit-bills.service.ts` → `recalculateFees()`
- DB 스키마 원본: `scripts/all_reset.sql`
- 이전 관련 계획: `docs/plans/008_호실별_청구서_수정_기능.md` (이사정산의 기초가 된 수정 기능)

---

**작성자**: Claude Code
**검토자**: -
**승인자**: -
