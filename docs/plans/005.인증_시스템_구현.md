# 인증 시스템 구현 계획
> 작성일: 2025-01-17
> 작성자: Claude
> 버전: 2.0

## 📋 요구사항 정리

### 1. 관리자 요구사항
- 기본 admin 계정 생성
- dashboard 전체 접근 권한
- 유저 추가/변경/삭제 기능
- 호실별 사용자 배정 관리

### 2. 사용자 요구사항
- 별도 회원가입 없이 관리자가 계정 생성
- 로그인 후 본인 정보 수정 가능
- 본인 호실의 청구서만 조회 가능
- 입주일 이후 청구서만 표시

### 3. 보안 요구사항
- 입주자 변경 시 이전 입주자 데이터 접근 차단
- 기본 비밀번호: 0000
- JWT 기반 세션 관리

## 🗄️ 데이터베이스 설계

### users 테이블 변경사항
```sql
ALTER TABLE users ADD COLUMN unit_id INT;
ALTER TABLE users ADD COLUMN status ENUM('active', 'inactive', 'pending') DEFAULT 'pending';
ALTER TABLE users ADD COLUMN move_in_date DATE;
ALTER TABLE users ADD COLUMN move_out_date DATE;
ALTER TABLE users ADD COLUMN phone VARCHAR(20);
ALTER TABLE users ADD COLUMN email VARCHAR(100);
ALTER TABLE users ADD COLUMN full_name VARCHAR(100);
ALTER TABLE users ADD FOREIGN KEY (unit_id) REFERENCES units(id) ON DELETE SET NULL;
ALTER TABLE users ADD INDEX idx_unit_id (unit_id);
ALTER TABLE users ADD INDEX idx_status (status);
```

### units 테이블 변경사항
```sql
-- tenant_name과 contact는 더 이상 사용하지 않음 (users 테이블로 이관)
-- 기존 데이터는 마이그레이션 필요
```

### 데이터 관계
- 1 Unit : N Users (이력 관리)
- Active User만 현재 입주자
- move_out_date가 설정되면 inactive 상태

## 🔐 인증 시스템 아키텍처

### 1. 기술 스택
- **NextAuth.js v5**: Next.js 14 App Router 호환
- **JWT**: 세션 토큰 관리
- **bcrypt**: 비밀번호 해싱
- **MySQL**: 사용자 데이터 저장

### 2. 인증 플로우
```
[로그인 페이지]
    ↓ (credentials)
[NextAuth 검증]
    ↓ (JWT 발급)
[role 확인]
    ├─ admin → /dashboard
    └─ viewer → /my
```

### 3. 권한 체계
| Role | 권한 | 접근 가능 경로 |
|------|------|--------------|
| admin | 전체 시스템 관리 | /dashboard/*, /api/* |
| viewer | 본인 데이터 조회 | /my/*, /api/my/* |

## 📁 파일 구조

```
coloco-apartment/
├── app/
│   ├── api/
│   │   ├── auth/
│   │   │   └── [...nextauth]/
│   │   │       └── route.ts         # NextAuth API 라우트
│   │   ├── users/
│   │   │   ├── route.ts             # 유저 목록 조회/생성
│   │   │   ├── [id]/
│   │   │   │   └── route.ts         # 유저 상세/수정/삭제
│   │   │   └── check-username/
│   │   │       └── route.ts         # username 중복 체크
│   │   └── my/
│   │       ├── profile/
│   │       │   └── route.ts         # 본인 정보 수정
│   │       └── bills/
│   │           └── route.ts         # 본인 청구서 조회
│   ├── login/
│   │   ├── page.tsx                 # 통합 로그인 페이지
│   │   └── layout.tsx               # 로그인 레이아웃
│   ├── dashboard/
│   │   ├── users/                   # 유저 관리 (신규)
│   │   │   ├── page.tsx            # 유저 목록
│   │   │   └── [id]/
│   │   │       └── edit/
│   │   │           └── page.tsx    # 유저 수정
│   │   └── layout.tsx              # 관리자 권한 체크
│   └── my/                         # 사용자 전용 (신규)
│       ├── page.tsx                # 사용자 대시보드
│       ├── layout.tsx              # 사용자 권한 체크
│       ├── profile/
│       │   └── page.tsx           # 프로필 관리
│       └── bills/
│           ├── page.tsx           # 청구서 목록
│           └── [id]/
│               └── page.tsx       # 청구서 상세
├── components/
│   ├── auth/
│   │   ├── LoginForm.tsx          # 로그인 폼
│   │   ├── LogoutButton.tsx       # 로그아웃 버튼
│   │   └── AuthProvider.tsx       # 인증 컨텍스트
│   └── users/
│       ├── UserList.tsx           # 유저 목록 컴포넌트
│       ├── UserForm.tsx           # 유저 등록/수정 폼
│       └── UserDeleteModal.tsx    # 유저 삭제 확인
├── lib/
│   ├── auth.ts                    # NextAuth 설정
│   ├── auth-utils.ts             # 인증 유틸리티
│   └── session.ts                 # 세션 관리
├── middleware.ts                   # 라우트 보호 미들웨어
└── scripts/
    └── migrate_users_table.sql    # DB 마이그레이션

```

## 🎯 구현 단계

### Phase 1: 데이터베이스 준비 (1시간)
- [ ] users 테이블 스키마 변경
- [ ] 마이그레이션 SQL 작성 및 실행
- [ ] 기존 units 데이터를 users로 이관
- [ ] admin 계정 생성 (username: admin, password: 0000)

### Phase 2: NextAuth 설정 (2시간)
- [ ] NextAuth.js 설치 및 설정
- [ ] JWT 전략 구성
- [ ] 로그인/로그아웃 API 구현
- [ ] 세션 관리 로직
- [ ] 미들웨어로 라우트 보호

### Phase 3: 로그인 페이지 (1시간)
- [ ] 로그인 UI 컴포넌트
- [ ] 폼 검증 및 에러 처리
- [ ] role별 리다이렉트
- [ ] 로그아웃 기능

### Phase 4: 관리자 - 유저 관리 (2시간)
- [ ] 유저 목록 페이지 (페이지네이션, 검색)
- [ ] 유저 생성 폼 (호실 선택, 기본 정보)
- [ ] 유저 수정 페이지
- [ ] 유저 삭제 (확인 모달)
- [ ] 호실 배정/해제 기능
- [ ] 상태 관리 (active/inactive)

### Phase 5: 사용자 대시보드 (1.5시간)
- [ ] /my 대시보드 메인
- [ ] 본인 호실 청구서 목록
- [ ] 청구서 상세 보기
- [ ] 입주일 기준 필터링
- [ ] 프로필 수정 페이지

### Phase 6: 통합 및 테스트 (0.5시간)
- [ ] 권한별 접근 테스트
- [ ] 데이터 필터링 검증
- [ ] 에러 처리 확인
- [ ] UI/UX 개선

## 🔧 주요 구현 내용

### 1. NextAuth 설정 (lib/auth.ts)
```typescript
import NextAuth from "next-auth"
import CredentialsProvider from "next-auth/providers/credentials"
import bcrypt from "bcryptjs"

export const authOptions = {
  providers: [
    CredentialsProvider({
      credentials: {
        username: { label: "Username", type: "text" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        // DB에서 사용자 조회
        // 비밀번호 검증
        // JWT 토큰에 role, unit_id 포함
      }
    })
  ],
  session: { strategy: "jwt" },
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.role = user.role
        token.unit_id = user.unit_id
      }
      return token
    },
    async session({ session, token }) {
      session.user.role = token.role
      session.user.unit_id = token.unit_id
      return session
    }
  }
}
```

### 2. 미들웨어 (middleware.ts)
```typescript
export function middleware(request: NextRequest) {
  const token = await getToken({ req: request })

  // /dashboard/* - admin only
  if (request.nextUrl.pathname.startsWith('/dashboard')) {
    if (!token || token.role !== 'admin') {
      return NextResponse.redirect('/login')
    }
  }

  // /my/* - authenticated users only
  if (request.nextUrl.pathname.startsWith('/my')) {
    if (!token) {
      return NextResponse.redirect('/login')
    }
  }
}
```

### 3. 유저 관리 API
```typescript
// GET /api/users - 유저 목록
// POST /api/users - 유저 생성
// GET /api/users/[id] - 유저 상세
// PUT /api/users/[id] - 유저 수정
// DELETE /api/users/[id] - 유저 삭제
```

### 4. 사용자 청구서 필터링
```typescript
// 본인 호실 + 입주일 이후 청구서만 조회
const bills = await query(`
  SELECT ub.*, mb.bill_year, mb.bill_month
  FROM unit_bills ub
  JOIN monthly_bills mb ON ub.monthly_bill_id = mb.id
  WHERE ub.unit_id = ?
  AND DATE(CONCAT(mb.bill_year, '-', mb.bill_month, '-01')) >= ?
  ORDER BY mb.bill_year DESC, mb.bill_month DESC
`, [user.unit_id, user.move_in_date])
```

## 📊 UI 구성

### 1. 로그인 페이지 (/login)
- 중앙 정렬 카드 레이아웃
- Username/Password 입력
- 에러 메시지 표시
- 로딩 상태 표시

### 2. 유저 관리 페이지 (/dashboard/users)
- 테이블 형태 목록
- 검색/필터 기능
- 페이지네이션
- 추가/수정/삭제 버튼
- 상태 뱃지 (active/inactive)

### 3. 사용자 대시보드 (/my)
- 환영 메시지
- 현재 달 청구서 요약
- 최근 청구서 목록
- 프로필 수정 링크

### 4. 프로필 페이지 (/my/profile)
- 기본 정보 표시 (수정 불가)
- 비밀번호 변경
- 연락처 수정
- 이메일 수정

## 🔒 보안 고려사항

### 1. 인증
- bcrypt로 비밀번호 해싱 (salt rounds: 10)
- JWT 토큰 만료 시간: 24시간
- Refresh token 구현 (선택)

### 2. 권한
- role 기반 접근 제어 (RBAC)
- API 레벨 권한 검증
- 데이터 레벨 필터링

### 3. 보안 헤더
- CSRF 보호
- XSS 방지 (Content-Security-Policy)
- SQL Injection 방지 (Parameterized queries)

### 4. 감사 로그
- 로그인/로그아웃 기록
- 유저 관리 작업 기록
- 민감 작업 추적

## 📈 향후 개선사항

1. **이메일 인증**: 비밀번호 재설정
2. **2FA**: 2단계 인증
3. **SSO**: 소셜 로그인
4. **세션 관리**: 동시 접속 제한
5. **감사 대시보드**: 관리자용 로그 뷰어

## 🚀 예상 일정

| 단계 | 예상 시간 | 담당 |
|------|----------|------|
| Phase 1 | 1시간 | DB 마이그레이션 |
| Phase 2 | 2시간 | 인증 시스템 |
| Phase 3 | 1시간 | 로그인 페이지 |
| Phase 4 | 2시간 | 유저 관리 |
| Phase 5 | 1.5시간 | 사용자 대시보드 |
| Phase 6 | 0.5시간 | 통합 테스트 |
| **총계** | **8시간** | - |

## 📝 참고사항

- NextAuth.js v5 사용 (App Router 호환)
- 기존 데이터 마이그레이션 필요
- 관리자 초기 비밀번호 변경 권장
- 프로덕션 배포 전 보안 감사 필요