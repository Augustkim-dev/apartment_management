# 008. 호실별 청구서 수정 기능 추가

**작성일**: 2025-11-10
**상태**: 계획 중
**목표**: 관리자가 각 호실별 청구 내역을 수정할 수 있는 기능 추가 (이사정산 등 특수 상황 대응)

---

## 1. 배경 및 목적

### 배경
- 세입자가 월 중간에 이사를 나가는 경우 (이사정산)
- 계량기 오류로 인한 수정이 필요한 경우
- 특별한 조정이 필요한 경우

### 목적
관리자가 청구서 관리 페이지에서 호실별로 사용량, 요금 항목을 수정하고 저장할 수 있는 기능 제공

---

## 2. 데이터베이스 구조 분석

### 현재 `unit_bills` 테이블 구조
```sql
CREATE TABLE unit_bills (
    id INT PRIMARY KEY AUTO_INCREMENT,
    monthly_bill_id INT NOT NULL,
    unit_id INT NOT NULL,

    -- 검침 정보
    previous_reading DECIMAL(10, 2),
    current_reading DECIMAL(10, 2),
    usage_amount DECIMAL(10, 2) NOT NULL,
    usage_rate DECIMAL(10, 4) NOT NULL,

    -- 요금 상세 (8개 항목)
    basic_fee DECIMAL(10, 2),
    power_fee DECIMAL(10, 2),
    climate_fee DECIMAL(10, 2),
    fuel_fee DECIMAL(10, 2),
    power_factor_fee DECIMAL(10, 2),
    vat DECIMAL(10, 2),
    power_fund DECIMAL(10, 2),
    tv_license_fee DECIMAL(10, 2),
    round_down DECIMAL(10, 2),
    total_amount DECIMAL(10, 2) NOT NULL,

    -- 기타
    previous_month_total DECIMAL(10, 2),
    unpaid_amount DECIMAL(10, 2) DEFAULT 0,
    due_date DATE,
    payment_status ENUM('pending', 'paid', 'overdue') DEFAULT 'pending',
    payment_date DATE,
    payment_method VARCHAR(50),
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
)
```

### 필요한 데이터베이스 변경사항
```sql
-- unit_bills 테이블에 새 컬럼 추가
ALTER TABLE unit_bills
ADD COLUMN edit_reason VARCHAR(255) DEFAULT NULL AFTER notes,
ADD COLUMN is_manually_edited BOOLEAN DEFAULT FALSE AFTER edit_reason;

-- 인덱스 추가
ALTER TABLE unit_bills ADD INDEX idx_manually_edited (is_manually_edited);
```

**새 컬럼 설명**:
- `edit_reason`: 수정 사유 (예: "이사정산", "계량기 오류 수정", "기타 조정")
- `is_manually_edited`: 자동 계산 vs 수동 편집 구분 플래그

### 감사 추적 (`bill_history` 테이블 활용)
```sql
-- 기존 테이블 활용 (변경 없음)
CREATE TABLE bill_history (
    id INT PRIMARY KEY AUTO_INCREMENT,
    unit_bill_id INT NOT NULL,
    action ENUM('created', 'updated', 'paid', 'cancelled') NOT NULL,
    old_values TEXT,     -- JSON 형식의 이전 값
    new_values TEXT,     -- JSON 형식의 새 값
    changed_by INT,      -- user_id
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (unit_bill_id) REFERENCES unit_bills(id) ON DELETE CASCADE,
    FOREIGN KEY (changed_by) REFERENCES users(id) ON DELETE SET NULL
)
```

---

## 3. 사용자 플로우

### 현재 네비게이션
```
청구서관리 (/dashboard/bills)
  → 월별 청구서 상세 (/dashboard/bills/[id])
    → 호실별 리스트 표시
      → [고지서 보기] 버튼 → 고지서 뷰어 (/dashboard/bills/[id]/units/[unitId])
```

### 새로운 네비게이션 (추가)
```
청구서관리 (/dashboard/bills)
  → 월별 청구서 상세 (/dashboard/bills/[id])
    → 호실별 리스트 표시
      → [수정] 버튼 → 편집 페이지 (/dashboard/bills/[id]/units/[unitId]/edit) ← 신규
        → 사용량, 요금 수정
        → 수정 사유 입력
        → [저장] → 감사 기록 생성 → 목록으로 돌아가기
```

---

## 4. 편집 모드 2가지

### 모드 1: 비율 재계산 (Proportional Recalculation)
**용도**: 월 중간 이사로 인한 사용량 조정

**동작 방식**:
1. 관리자가 `usage_amount` (사용량)만 수정
2. 시스템이 건물 전체 요금 대비 비율로 모든 요금 항목 자동 재계산
3. 계산 공식:
   ```javascript
   호실별 요금 = 건물 전체 요금 × (호실 사용량 ÷ 건물 전체 사용량)
   ```

**예시**:
- 원래 사용량: 147.4 kWh (한 달 전체)
- 수정 사용량: 73.7 kWh (보름 사용 후 이사)
- 시스템이 모든 요금을 50% 비율로 자동 재계산

### 모드 2: 직접 입력 (Manual Override)
**용도**: 특별한 조정이나 수정이 필요한 경우

**동작 방식**:
1. 관리자가 모든 요금 항목을 직접 입력 가능
2. 시스템은 합계 검증만 수행
3. `is_manually_edited = true` 플래그 설정

**예시**:
- 계량기 오류로 특정 항목만 수정 필요
- 특별 할인이나 조정 적용

---

## 5. 편집 가능 항목

### A. 검침 정보
- `previous_reading` - 전월 지침
- `current_reading` - 당월 지침
- `usage_amount` - 사용량 (자동 계산: 당월 - 전월)

### B. 요금 항목 (8개)
1. `basic_fee` - 기본료
2. `power_fee` - 전력량요금
3. `climate_fee` - 기후환경요금
4. `fuel_fee` - 연료비조정액
5. `power_factor_fee` - 역률요금
6. `vat` - 부가가치세
7. `power_fund` - 전력기금
8. `tv_license_fee` - TV수신료
9. `round_down` - 단수처리

### C. 총액
- `total_amount` - 총 청구액 (자동 합산 또는 직접 입력)

### D. 메타정보
- `edit_reason` - 수정 사유 (필수) ⭐ 새 항목
- `notes` - 비고

---

## 6. UI 설계

### 편집 페이지 레이아웃
```
┌─────────────────────────────────────────────────┐
│ [← 뒤로] 호실별 청구서 수정                        │
│ 2025년 7월 - 201호 (입주자201)                    │
├─────────────────────────────────────────────────┤
│ 📋 수정 모드 선택                                  │
│ ◉ 비율 재계산 (사용량만 수정)                       │
│ ○ 직접 입력 (모든 항목 수정)                       │
├─────────────────────────────────────────────────┤
│ 🔢 검침 정보                                       │
│ ┌──────────┬──────────┬──────────┐              │
│ │전월 지침  │당월 지침  │사용량     │              │
│ │1753.9    │1901.3    │147.4     │              │
│ └──────────┴──────────┴──────────┘              │
├─────────────────────────────────────────────────┤
│ 💰 요금 상세 (원)                                  │
│ 기본료:              ▢ 8,454                     │
│ 전력량요금:          ▢ 19,589                    │
│ 기후환경요금:        ▢ 1,373                     │
│ 연료비조정액:        ▢ 763                       │
│ 역률요금:            ▢ -85                       │
│ 부가가치세:          ▢ 3,009                     │
│ 전력기금:            ▢ 918                       │
│ TV수신료:            ▢ 0                         │
│ 단수처리:            ▢ -1                        │
│ ───────────────────────────────────             │
│ 총 청구액:           34,020원                     │
├─────────────────────────────────────────────────┤
│ 📝 수정 정보                                       │
│ 수정 사유*:  [이사정산 ▼]                         │
│              - 이사정산                           │
│              - 계량기 오류 수정                    │
│              - 기타 조정                          │
│ 비고:        [                    ]              │
├─────────────────────────────────────────────────┤
│ [취소]  [재계산 미리보기]  [저장]                  │
└─────────────────────────────────────────────────┘
```

### 주요 UI 기능
1. **편집 모드 토글**: 라디오 버튼으로 선택
2. **실시간 계산**: 비율 재계산 모드에서 사용량 변경 시 즉시 반영
3. **유효성 검사**: 인라인 에러 메시지 표시
4. **미리보기**: 저장 전 계산 결과 확인
5. **확인 모달**: 최종 저장 전 확인 대화상자

---

## 7. 유효성 검사 규칙

### 클라이언트 측 검증
```typescript
// 필수 항목
- usage_amount > 0
- total_amount > 0
- edit_reason (비어있지 않음)

// 검침 값 검증
- current_reading >= previous_reading
- usage_amount = current_reading - previous_reading (오차 ±0.1 이내)

// 합계 검증 (직접 입력 모드)
- 개별 요금 합계 ≈ total_amount (오차 ±100원 이내)
```

### 서버 측 검증
- 동일한 검증 규칙 적용
- 사용자 권한 확인 (관리자만 가능)
- unit_bill 존재 여부 확인
- SQL 인젝션 방지 (파라미터화된 쿼리)

---

## 8. 구현 단계

### Phase 1: 데이터베이스 마이그레이션
**파일**: `scripts/add-unit-bill-edit-fields.sql` (신규)

**작업 내용**:
- [ ] SQL 스크립트 작성
- [ ] 로컬 환경에서 마이그레이션 실행
- [ ] 프로덕션 DB 백업 후 마이그레이션

---

### Phase 2: TypeScript 타입 정의
**파일**: `types/unit-bill-edit.ts` (신규)

**작업 내용**:
- [ ] UnitBillEditRequest 인터페이스 작성
- [ ] UnitBillEditResponse 인터페이스 작성
- [ ] 기존 types/index.ts에 export 추가

---

### Phase 3: Service 레이어
**파일**: `lib/services/unit-bills.service.ts` (수정)

**추가할 메서드**:
1. `updateUnitBill()` - 청구서 업데이트
2. `recalculateFees()` - 비율 재계산

**작업 내용**:
- [ ] Service 메서드 구현
- [ ] 트랜잭션 처리
- [ ] 에러 핸들링
- [ ] 단위 테스트 작성

---

### Phase 4: API 엔드포인트
**파일**: `app/api/bills/[id]/units/[unitId]/edit/route.ts` (신규)

**구현 내용**:
- GET - 편집을 위한 데이터 조회
- PATCH - 청구서 업데이트

**작업 내용**:
- [ ] API 라우트 생성
- [ ] GET/PATCH 핸들러 구현
- [ ] 에러 처리
- [ ] Postman/curl로 API 테스트

---

### Phase 5: 편집 페이지 UI
**파일**: `app/dashboard/bills/[id]/units/[unitId]/edit/page.tsx` (신규)

**주요 컴포넌트**:
- 편집 모드 선택 (라디오 버튼)
- 검침 정보 입력
- 요금 항목 입력
- 수정 사유 입력
- 저장/취소 버튼

**작업 내용**:
- [ ] 페이지 컴포넌트 생성
- [ ] 편집 모드 토글 구현
- [ ] 실시간 계산 로직
- [ ] 유효성 검사 UI
- [ ] 반응형 레이아웃

---

### Phase 6: 기존 페이지 수정
**파일**: `app/dashboard/bills/[id]/page.tsx` (수정)

**변경 내용**: 호실별 리스트에 "수정" 버튼 추가

**작업 내용**:
- [ ] 수정 버튼 추가
- [ ] 링크 동작 테스트

---

### Phase 7: 통합 테스트 및 문서화

**테스트 체크리스트**:
- [ ] 관리자가 편집 페이지 접근 가능
- [ ] 비율 재계산 모드 정확성
- [ ] 직접 입력 모드 동작
- [ ] 유효성 검사 모든 케이스
- [ ] 감사 기록 생성 확인
- [ ] UI 데이터 표시 정확성
- [ ] 성공/에러 메시지 표시
- [ ] 네비게이션 동작
- [ ] 반응형 레이아웃

**문서 작성**:
- [ ] worklog 문서 작성
- [ ] API 문서 업데이트
- [ ] 사용자 가이드 작성

---

## 9. 보안 및 권한

### 인증 및 권한
- **인증**: 로그인된 사용자만 접근
- **권한**: 관리자 역할(role='admin')만 수정 가능
- **감사 추적**: 모든 변경 사항 기록 (changed_by 필드)

### 데이터 보안
- **SQL 인젝션 방지**: 파라미터화된 쿼리 사용
- **입력 검증**: 서버 측에서 이중 검증
- **트랜잭션**: 원자적 업데이트 보장

---

## 10. 향후 개선 사항

### 단기 (Phase 8)
- 다중 호실 일괄 수정 기능
- 수정 이력 상세 비교 뷰 (diff)
- Excel 가져오기/내보내기

### 중기
- 수정 승인 워크플로우 (결재 시스템)
- 이메일 알림 (수정 시 관리자에게 통보)
- 되돌리기(Undo) 기능

### 장기
- 머신러닝 기반 이상 사용량 감지
- 자동 이사정산 계산 (일할 계산)
- 모바일 앱 지원

---

## 11. 예상 일정

| Phase | 작업 내용 | 예상 소요 |
|-------|----------|----------|
| 1 | DB 마이그레이션 | 0.5일 |
| 2 | TypeScript 타입 | 0.5일 |
| 3 | Service 레이어 | 1.5일 |
| 4 | API 엔드포인트 | 1일 |
| 5 | 편집 페이지 UI | 2일 |
| 6 | 기존 페이지 수정 | 0.5일 |
| 7 | 테스트 및 문서 | 1일 |
| **총합** | | **7일** |

---

## 12. 위험 요소 및 대응 방안

### 위험 1: 계산 정확도
**위험**: 비율 재계산 시 반올림 오차로 인한 합계 불일치
**대응**: 10원 단위 반올림 후 차액 조정 로직 추가

### 위험 2: 동시 수정
**위험**: 여러 관리자가 동시에 같은 청구서 수정
**대응**: Optimistic locking (updated_at 필드 체크) 구현

### 위험 3: 데이터 무결성
**위험**: 수동 입력 시 잘못된 값 입력
**대응**: 엄격한 유효성 검사 및 확인 단계 추가

---

## 13. 성공 지표

1. **기능 완성도**: 모든 편집 시나리오 정상 동작
2. **정확도**: 계산 오차 ±10원 이내
3. **성능**: 페이지 로드 < 1초, 저장 < 2초
4. **사용성**: 관리자가 3단계 이내 수정 완료
5. **안정성**: 감사 기록 100% 보존

---

## 참고 자료

- 기존 계산 엔진: `lib/calculation/`
- 기존 편집 패턴: `/dashboard/settlements` 페이지
- 데이터베이스 스키마: `scripts/all_reset.sql`
- API 패턴: `/api/bills/[id]/billing-info`

---

**작성자**: Claude Code
**검토자**: -
**승인자**: -
