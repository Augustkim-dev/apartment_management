# Phase 1: MySQL 연결 설정 및 테이블 생성

## 개요
아르노빌리지 전기료 관리 시스템의 데이터베이스 기반을 구축하는 단계입니다. 자체 MySQL 서버를 활용하여 완전 무료로 데이터를 관리합니다.

## 목표
- MySQL 데이터베이스 스키마 설계 및 생성
- Next.js에서 MySQL 연결 설정
- 기본 CRUD 작업을 위한 데이터베이스 유틸리티 구현

## 작업 내용

### 1. 데이터베이스 스키마 설계

#### 1.1 데이터베이스 생성
```sql
CREATE DATABASE IF NOT EXISTS coloco_apartment 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE coloco_apartment;
```

#### 1.2 테이블 구조

**users (사용자 관리)**
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    role ENUM('admin', 'viewer') DEFAULT 'viewer',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**units (호실 정보)**
```sql
CREATE TABLE units (
    id INT PRIMARY KEY AUTO_INCREMENT,
    unit_number VARCHAR(20) UNIQUE NOT NULL,
    tenant_name VARCHAR(100),
    contact VARCHAR(20),
    email VARCHAR(100),
    status ENUM('occupied', 'vacant') DEFAULT 'occupied',
    move_in_date DATE,
    move_out_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_unit_number (unit_number),
    INDEX idx_status (status)
);
```

**monthly_bills (월별 총 청구서)**
```sql
CREATE TABLE monthly_bills (
    id INT PRIMARY KEY AUTO_INCREMENT,
    bill_year INT NOT NULL,
    bill_month INT NOT NULL,
    billing_period_start DATE NOT NULL,
    billing_period_end DATE NOT NULL,
    total_usage DECIMAL(10, 2) NOT NULL,
    total_amount DECIMAL(12, 2) NOT NULL,
    basic_fee DECIMAL(10, 2),
    power_fee DECIMAL(10, 2),
    climate_fee DECIMAL(10, 2),
    fuel_fee DECIMAL(10, 2),
    vat DECIMAL(10, 2),
    power_fund DECIMAL(10, 2),
    tv_license_fee DECIMAL(10, 2),
    round_down DECIMAL(10, 2),
    pdf_file_name VARCHAR(255),
    excel_file_name VARCHAR(255),
    created_by INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_bill_period (bill_year, bill_month),
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_bill_period (bill_year, bill_month)
);
```

**unit_bills (호실별 청구서)**
```sql
CREATE TABLE unit_bills (
    id INT PRIMARY KEY AUTO_INCREMENT,
    monthly_bill_id INT NOT NULL,
    unit_id INT NOT NULL,
    previous_reading DECIMAL(10, 2),
    current_reading DECIMAL(10, 2),
    usage_amount DECIMAL(10, 2) NOT NULL,
    usage_rate DECIMAL(5, 4) NOT NULL COMMENT '사용 비율',
    basic_fee DECIMAL(10, 2),
    power_fee DECIMAL(10, 2),
    climate_fee DECIMAL(10, 2),
    fuel_fee DECIMAL(10, 2),
    vat DECIMAL(10, 2),
    power_fund DECIMAL(10, 2),
    tv_license_fee DECIMAL(10, 2),
    round_down DECIMAL(10, 2),
    total_amount DECIMAL(10, 2) NOT NULL,
    payment_status ENUM('pending', 'paid', 'overdue') DEFAULT 'pending',
    payment_date DATE,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (monthly_bill_id) REFERENCES monthly_bills(id) ON DELETE CASCADE,
    FOREIGN KEY (unit_id) REFERENCES units(id),
    UNIQUE KEY unique_unit_bill (monthly_bill_id, unit_id),
    INDEX idx_payment_status (payment_status),
    INDEX idx_unit_id (unit_id)
);
```

**bill_history (청구서 변경 이력)**
```sql
CREATE TABLE bill_history (
    id INT PRIMARY KEY AUTO_INCREMENT,
    unit_bill_id INT NOT NULL,
    action ENUM('created', 'updated', 'paid', 'cancelled') NOT NULL,
    old_values TEXT COMMENT 'JSON 형식으로 저장',
    new_values TEXT COMMENT 'JSON 형식으로 저장',
    changed_by INT,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (unit_bill_id) REFERENCES unit_bills(id),
    FOREIGN KEY (changed_by) REFERENCES users(id),
    INDEX idx_unit_bill (unit_bill_id)
);
```

**parsed_pdf_data (PDF 파싱 원본 데이터) - Phase 2 추가**
```sql
CREATE TABLE parsed_pdf_data (
    id INT PRIMARY KEY AUTO_INCREMENT,
    monthly_bill_id INT COMMENT '연결된 월별 청구서 ID',
    file_name VARCHAR(255) NOT NULL COMMENT '원본 파일명',
    file_hash VARCHAR(64) COMMENT 'SHA256 해시값 (중복 방지)',
    customer_number VARCHAR(50) COMMENT '고객번호',
    invoice_number VARCHAR(50) COMMENT '청구서번호',
    billing_period_start DATE COMMENT '사용기간 시작',
    billing_period_end DATE COMMENT '사용기간 종료',
    previous_reading DECIMAL(10, 2) COMMENT '전월지침',
    current_reading DECIMAL(10, 2) COMMENT '당월지침',
    total_usage DECIMAL(10, 2) COMMENT '총 사용량 (kWh)',
    basic_fee DECIMAL(10, 2) COMMENT '기본요금',
    power_fee DECIMAL(10, 2) COMMENT '전력량요금',
    climate_fee DECIMAL(10, 2) COMMENT '기후환경요금',
    fuel_fee DECIMAL(10, 2) COMMENT '연료비조정액',
    vat DECIMAL(10, 2) COMMENT '부가가치세',
    power_fund DECIMAL(10, 2) COMMENT '전력산업기반기금',
    tv_license_fee DECIMAL(10, 2) COMMENT 'TV수신료',
    round_down DECIMAL(10, 2) COMMENT '단수처리',
    total_amount DECIMAL(10, 2) COMMENT '청구금액',
    due_date DATE COMMENT '납기일',
    raw_text TEXT COMMENT '추출된 전체 텍스트',
    parsed_data TEXT COMMENT 'JSON 형식의 전체 파싱 데이터',
    parse_warnings TEXT COMMENT '파싱 경고 메시지',
    parsed_by INT COMMENT '파싱 수행자',
    parsed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (monthly_bill_id) REFERENCES monthly_bills(id) ON DELETE SET NULL,
    FOREIGN KEY (parsed_by) REFERENCES users(id),
    INDEX idx_file_hash (file_hash),
    INDEX idx_parsed_at (parsed_at),
    INDEX idx_billing_period (billing_period_start, billing_period_end)
);
```

**parsed_excel_data (Excel 파싱 원본 데이터) - Phase 2 추가**
```sql
CREATE TABLE parsed_excel_data (
    id INT PRIMARY KEY AUTO_INCREMENT,
    monthly_bill_id INT COMMENT '연결된 월별 청구서 ID',
    file_name VARCHAR(255) NOT NULL COMMENT '원본 파일명',
    file_hash VARCHAR(64) COMMENT 'SHA256 해시값 (중복 방지)',
    sheet_name VARCHAR(100) COMMENT '시트명',
    total_units INT COMMENT '총 호실 수',
    total_usage DECIMAL(10, 2) COMMENT '총 사용량',
    average_usage DECIMAL(10, 2) COMMENT '평균 사용량',
    unit_data TEXT COMMENT 'JSON 형식의 호실별 데이터',
    column_mapping TEXT COMMENT 'JSON 형식의 컬럼 매핑 정보',
    parse_warnings TEXT COMMENT '파싱 경고 메시지',
    parsed_by INT COMMENT '파싱 수행자',
    parsed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (monthly_bill_id) REFERENCES monthly_bills(id) ON DELETE SET NULL,
    FOREIGN KEY (parsed_by) REFERENCES users(id),
    INDEX idx_file_hash (file_hash),
    INDEX idx_parsed_at (parsed_at)
);
```

### 2. Next.js 프로젝트 설정

#### 2.1 프로젝트 생성
```bash
npx create-next-app@latest coloco-apartment-management \
  --typescript \
  --tailwind \
  --app \
  --no-src-dir \
  --import-alias "@/*"
```

#### 2.2 필요 패키지 설치
```bash
npm install mysql2
npm install dotenv
npm install --save-dev @types/node
```

#### 2.3 환경 변수 설정
`.env.local` 파일 생성:
```env
# MySQL 연결 정보
MYSQL_HOST=your-mysql-server-ip
MYSQL_PORT=3306
MYSQL_USER=your-username
MYSQL_PASSWORD=your-password
MYSQL_DATABASE=coloco_apartment

# 연결 풀 설정
MYSQL_CONNECTION_LIMIT=10
MYSQL_QUEUE_LIMIT=0
```

### 3. 데이터베이스 연결 모듈 구현

#### 3.1 연결 풀 생성 (`lib/db.ts`)
```typescript
import mysql from 'mysql2/promise';

const pool = mysql.createPool({
  host: process.env.MYSQL_HOST,
  port: parseInt(process.env.MYSQL_PORT || '3306'),
  user: process.env.MYSQL_USER,
  password: process.env.MYSQL_PASSWORD,
  database: process.env.MYSQL_DATABASE,
  waitForConnections: true,
  connectionLimit: parseInt(process.env.MYSQL_CONNECTION_LIMIT || '10'),
  queueLimit: parseInt(process.env.MYSQL_QUEUE_LIMIT || '0'),
  enableKeepAlive: true,
  keepAliveInitialDelay: 0,
});

export default pool;
```

#### 3.2 데이터베이스 유틸리티 함수 (`lib/db-utils.ts`)
```typescript
import pool from './db';
import { RowDataPacket, ResultSetHeader } from 'mysql2';

export async function query<T extends RowDataPacket[]>(
  sql: string,
  params?: any[]
): Promise<T> {
  const [results] = await pool.execute<T>(sql, params);
  return results;
}

export async function execute(
  sql: string,
  params?: any[]
): Promise<ResultSetHeader> {
  const [results] = await pool.execute<ResultSetHeader>(sql, params);
  return results;
}

export async function transaction<T>(
  callback: (connection: any) => Promise<T>
): Promise<T> {
  const connection = await pool.getConnection();
  try {
    await connection.beginTransaction();
    const result = await callback(connection);
    await connection.commit();
    return result;
  } catch (error) {
    await connection.rollback();
    throw error;
  } finally {
    connection.release();
  }
}
```

### 4. 초기 데이터 삽입

#### 4.1 관리자 계정 생성
```sql
INSERT INTO users (username, password, role) 
VALUES ('admin', '$2b$10$YourHashedPasswordHere', 'admin');
```

#### 4.2 샘플 호실 데이터
```sql
INSERT INTO units (unit_number, tenant_name, contact, status) VALUES
('101', '홍길동', '010-1234-5678', 'occupied'),
('102', '김철수', '010-2345-6789', 'occupied'),
('103', NULL, NULL, 'vacant'),
-- ... 60개 호실 데이터
('601', '박영희', '010-9876-5432', 'occupied');
```

### 5. 연결 테스트

#### 5.1 연결 테스트 API (`app/api/test-db/route.ts`)
```typescript
import { NextResponse } from 'next/server';
import { query } from '@/lib/db-utils';

export async function GET() {
  try {
    const result = await query('SELECT 1 as test');
    return NextResponse.json({ 
      success: true, 
      message: 'Database connected successfully',
      result 
    });
  } catch (error) {
    return NextResponse.json({ 
      success: false, 
      error: error.message 
    }, { status: 500 });
  }
}
```

## 테스트 체크리스트

- [ ] MySQL 서버 접속 가능 여부 확인
- [ ] 데이터베이스 및 테이블 생성 완료
- [ ] Next.js에서 데이터베이스 연결 성공
- [ ] 기본 CRUD 작업 테스트
- [ ] 트랜잭션 처리 테스트
- [ ] 연결 풀 동작 확인
- [ ] 한글 데이터 입출력 정상 동작

## 보안 고려사항

1. **환경 변수 관리**
   - `.env.local` 파일을 `.gitignore`에 추가
   - 프로덕션 환경에서는 Vercel 환경 변수 사용

2. **MySQL 서버 보안**
   - 특정 IP만 접속 허용
   - SSL 연결 사용 권장
   - 최소 권한 원칙 적용

3. **SQL Injection 방지**
   - Prepared Statements 사용
   - 사용자 입력 값 검증

## 예상 소요 시간
- 데이터베이스 설계 및 생성: 2시간
- Next.js 프로젝트 설정: 1시간
- 연결 모듈 구현: 2시간
- 테스트 및 디버깅: 1시간
- **총 예상 시간: 6시간**

## 다음 단계
Phase 2: 인증 시스템 구현으로 진행